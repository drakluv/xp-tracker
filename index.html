<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quest XP Tracker</title>

<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --line:rgba(0,0,0,0.08);
  --primary:#7c3aed;
  --primary2:#2563eb;
  --accent:#22c55e;
  --danger:#ef4444;
}

[data-theme="dark"]{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --line:rgba(255,255,255,0.1);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

.topbar{
  position:sticky;
  top:0;
  z-index:999;
  padding:16px;
  background:linear-gradient(90deg,var(--primary),var(--primary2));
  color:white;
}

.topbarRow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}

.topbar h1{
  margin:0;
  font-size:20px;
}

.stats{
  margin-top:10px;
}

.levelBar{
  height:12px;
  background:rgba(255,255,255,0.25);
  border-radius:999px;
  overflow:hidden;
  margin-top:6px;
}

.levelFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#34d399,#22c55e);
  transition:width .2s ease;
}

/* Menu */
.menuWrap{
  position:relative;
  flex-shrink:0;
}

.menuBtn{
  border:1px solid rgba(255,255,255,0.35);
  background:rgba(255,255,255,0.18);
  color:white;
  padding:10px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
}

.menuDropdown{
  position:absolute;
  right:0;
  top:44px;
  min-width:180px;
  background:var(--card);
  color:var(--text);
  border:1px solid var(--line);
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,0.18);
  padding:10px;
  display:none;
  z-index:1000;
}

.menuDropdown.open{ display:block; }

.menuItem{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px;
  border-radius:10px;
}

.menuItem:hover{
  background:rgba(0,0,0,0.05);
}
[data-theme="dark"] .menuItem:hover{
  background:rgba(255,255,255,0.06);
}

.menuLabel{
  font-weight:800;
}

.switch{
  width:22px;
  height:22px;
  accent-color:var(--accent);
}

.page{
  padding:16px;
  max-width:900px;
  margin:auto;
}

.category{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
  border:1px solid var(--line);
}

.category h3{
  margin:0 0 10px 0;
}

.task, .reward{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid var(--line);
  gap:10px;
}

.task:last-child, .reward:last-child{
  border-bottom:none;
}

.left{
  display:flex;
  gap:10px;
  flex:1;
  min-width:0;
}

.task input{
  width:20px;
  height:20px;
  accent-color:var(--accent);
}

.labelText{
  white-space:normal;
  word-break:break-word;
}

.labelText.done{
  text-decoration:line-through;
  opacity:.5;
}

button{
  background:var(--accent);
  border:none;
  padding:8px 12px;
  border-radius:8px;
  color:white;
  font-weight:900;
  cursor:pointer;
}

button.delete{
  background:var(--danger);
}

/* 1) Buy buttons same size */
.buyBtn{
  min-width:78px;
  text-align:center;
}

.reward.unlocked{
  box-shadow:0 0 0 2px rgba(34,197,94,.3),0 0 20px rgba(34,197,94,.4);
  border-radius:10px;
  padding:8px;
}

.form{
  margin-top:20px;
}

input{
  padding:8px;
  margin:4px 0;
  width:100%;
  border-radius:8px;
  border:1px solid var(--line);
  background:transparent;
  color:var(--text);
}

@media (max-width: 720px){
  .topbarRow{ align-items:flex-start; }
  .menuDropdown{ top:46px; }
}
</style>
</head>

<body>

<div class="topbar">
  <div class="topbarRow">
    <div>
      <h1>Quest XP Tracker</h1>
      <div class="stats">
        Spendable XP: <strong id="spendable">0</strong><br>
        Earned XP: <strong id="earned">0</strong><br>
        Level: <strong id="level">1</strong>
        <div class="levelBar">
          <div class="levelFill" id="levelFill"></div>
        </div>
      </div>
    </div>

    <!-- 2) Menu in top-right -->
    <div class="menuWrap">
      <button class="menuBtn" id="menuBtn" aria-haspopup="true" aria-expanded="false">â˜°</button>
      <div class="menuDropdown" id="menuDropdown">
        <!-- 3) Darkmode inside menu -->
        <div class="menuItem">
          <span class="menuLabel">Darkmode</span>
          <input class="switch" type="checkbox" id="darkToggle">
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page">
  <div class="category">
    <h3>Tasks</h3>
    <div id="taskList"></div>
  </div>

  <div class="category">
    <h3>Rewards</h3>
    <div id="rewardList"></div>
  </div>

  <div class="category form">
    <h3>Add Task</h3>
    <input id="taskName" placeholder="Task name">
    <input id="taskPoints" type="number" placeholder="Points">
    <button onclick="addTask()">Add Task</button>
  </div>

  <div class="category form">
    <h3>Add Reward</h3>
    <input id="rewardName" placeholder="Reward name">
    <input id="rewardCost" type="number" placeholder="Cost">
    <button onclick="addReward()">Add Reward</button>
  </div>
</div>

<script>
// UUID fallback
function uuid(){
  if(window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'id-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2);
}

// Storage helpers
function get(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch{ return fallback; }
}
function set(key,value){ localStorage.setItem(key,JSON.stringify(value)); }

// Theme
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  set("theme", theme);
  document.getElementById("darkToggle").checked = (theme === "dark");
}
function toggleTheme(){
  const current = get("theme","light");
  applyTheme(current === "dark" ? "light" : "dark");
}

// Menu logic
const menuBtn = () => document.getElementById("menuBtn");
const menuDrop = () => document.getElementById("menuDropdown");

function setMenuOpen(open){
  const d = menuDrop();
  const b = menuBtn();
  if(open){
    d.classList.add("open");
    b.setAttribute("aria-expanded","true");
  }else{
    d.classList.remove("open");
    b.setAttribute("aria-expanded","false");
  }
}

document.addEventListener("click",(e)=>{
  const wrap = e.target.closest(".menuWrap");
  if(wrap){
    if(e.target.id === "menuBtn"){
      setMenuOpen(!menuDrop().classList.contains("open"));
    }
    return;
  }
  setMenuOpen(false);
});

document.getElementById("darkToggle").addEventListener("change",()=>{
  toggleTheme();
});

// XP/Level math (Earned XP only)
function xpToNext(level){ return 50 + (level-1)*25; }

function computeLevel(xp){
  let lvl=1, remaining=xp;
  while(true){
    let need=xpToNext(lvl);
    if(remaining<need) return {lvl,progress:remaining,need};
    remaining-=need; lvl++;
  }
}

// State
let spendableXp = get("spendableXp",0);
let earnedXp = get("earnedXp",0);
let tasks = get("tasks",[
  {id:uuid(), name:"Book Forklift Licence", points:5},
  {id:uuid(), name:"Book Working at Heights", points:4},
  {id:uuid(), name:"Book Confined Spaces", points:4},
  {id:uuid(), name:"Fill out trade qualification transfer paperwork", points:6}
]);
let rewards = get("rewards",[
  {id:uuid(), name:"Small treat", cost:10},
  {id:uuid(), name:"Fun hobby / mini outing", cost:25},
  {id:uuid(), name:"Bigger reward", cost:50}
]);
let done = get("done",{}); // taskId:true

function updateHeader(){
  document.getElementById("spendable").textContent=spendableXp;
  document.getElementById("earned").textContent=earnedXp;

  const lvl=computeLevel(earnedXp);
  document.getElementById("level").textContent=lvl.lvl;
  document.getElementById("levelFill").style.width=(lvl.progress/lvl.need*100)+"%";

  set("spendableXp",spendableXp);
  set("earnedXp",earnedXp);
}

function renderTasks(){
  const list=document.getElementById("taskList");
  list.innerHTML="";
  tasks.forEach(task=>{
    const row=document.createElement("div");
    row.className="task";

    const left=document.createElement("div");
    left.className="left";

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.checked=!!done[task.id];

    const label=document.createElement("div");
    label.className="labelText";
    label.textContent=`${task.name} (${task.points} XP)`;
    if(cb.checked) label.classList.add("done");

    cb.onchange=()=>{
      if(cb.checked){
        spendableXp+=task.points;
        earnedXp+=task.points;
        done[task.id]=true;
      }else{
        spendableXp-=task.points;
        earnedXp-=task.points;
        if(spendableXp<0) spendableXp=0;
        if(earnedXp<0) earnedXp=0;
        delete done[task.id];
      }
      set("done",done);
      updateHeader();
      renderRewards();
      renderTasks();
    };

    left.appendChild(cb);
    left.appendChild(label);

    const del=document.createElement("button");
    del.textContent="Delete";
    del.className="delete";
    del.onclick=()=>{
      delete done[task.id];
      tasks=tasks.filter(t=>t.id!==task.id);
      set("tasks",tasks);
      set("done",done);
      renderTasks();
    };

    row.appendChild(left);
    row.appendChild(del);
    list.appendChild(row);
  });
}

function renderRewards(){
  const list=document.getElementById("rewardList");
  list.innerHTML="";
  rewards.forEach(r=>{
    const row=document.createElement("div");
    row.className="reward";
    if(spendableXp>=r.cost) row.classList.add("unlocked");

    const left=document.createElement("div");
    left.className="left";

    const buy=document.createElement("button");
    buy.textContent="Buy";
    buy.className="buyBtn";
    buy.onclick=()=>{
      if(spendableXp>=r.cost){
        spendableXp-=r.cost; // spendable only, level stays
        updateHeader();
        renderRewards();
        alert("Reward claimed!");
      }else{
        alert("Not enough XP.");
      }
    };

    const text=document.createElement("div");
    text.className="labelText";
    text.textContent=`${r.name} (Cost ${r.cost} XP)`;

    left.appendChild(buy);
    left.appendChild(text);

    const del=document.createElement("button");
    del.textContent="Delete";
    del.className="delete";
    del.onclick=()=>{
      rewards=rewards.filter(x=>x.id!==r.id);
      set("rewards",rewards);
      renderRewards();
    };

    row.appendChild(left);
    row.appendChild(del);
    list.appendChild(row);
  });
}

function addTask(){
  const name=document.getElementById("taskName").value.trim();
  const pts=parseInt(document.getElementById("taskPoints").value);
  if(!name||isNaN(pts)) return alert("Enter task + points");
  tasks.push({id:uuid(),name,points:pts});
  set("tasks",tasks);
  document.getElementById("taskName").value="";
  document.getElementById("taskPoints").value="";
  renderTasks();
}

function addReward(){
  const name=document.getElementById("rewardName").value.trim();
  const cost=parseInt(document.getElementById("rewardCost").value);
  if(!name||isNaN(cost)) return alert("Enter reward + cost");
  rewards.push({id:uuid(),name,cost});
  set("rewards",rewards);
  document.getElementById("rewardName").value="";
  document.getElementById("rewardCost").value="";
  renderRewards();
}

// Init
applyTheme(get("theme","light"));
updateHeader();
renderTasks();
renderRewards();
</script>

</body>
</html>
