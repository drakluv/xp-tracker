<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Quest Tracker</title>

<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:rgba(0,0,0,0.10);

    --primary:#7c3aed;
    --primary2:#2563eb;

    --accent:#22c55e;
    --danger:#ef4444;

    /* HUD theme */
    --hud1:#0ea5e9;
    --hud2:#22c55e;
    --hud3:#f97316; /* streak accent */
    --hudBg: rgba(255,255,255,0.14);
    --hudBorder: rgba(255,255,255,0.22);

    --shadow:0 10px 30px rgba(0,0,0,0.12);
    --radius:14px;
  }

  [data-theme="dark"]{
    --bg:#0b1220;
    --card:#111a2e;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:rgba(255,255,255,0.12);
    --shadow:0 10px 30px rgba(0,0,0,0.45);
    --hudBg: rgba(255,255,255,0.10);
    --hudBorder: rgba(255,255,255,0.18);
  }

  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }

  .topbar{
    position: sticky; top: 0; z-index: 999;
    padding: 14px 14px;
    background: linear-gradient(90deg, var(--primary), var(--primary2));
    color:#fff; box-shadow: var(--shadow);
  }
  .topbarInner{
    max-width: 1100px; margin: 0 auto;
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  }

  .leftTop{ flex:1; min-width:0; display:flex; flex-direction:column; gap:10px; }
  .appTitle{ font-weight:900; font-size:18px; letter-spacing:0.2px; margin:0; }

  .tabs{ display:flex; gap:10px; flex-wrap:wrap; }
  .tabBtn{
    border:1px solid rgba(255,255,255,0.28);
    background: rgba(255,255,255,0.16);
    color:#fff;
    padding:10px 12px;
    border-radius:999px;
    cursor:pointer;
    font-weight:900;
  }
  .tabBtn.active{ background: rgba(255,255,255,0.30); border-color: rgba(255,255,255,0.45); }

  /* HUD */
  .hud{ display:flex; flex-direction:column; align-items:flex-end; gap:10px; flex-shrink:0; }

  .menuWrap{ position:relative; width: fit-content; }
  .menuBtn{
    border:1px solid var(--hudBorder);
    background: linear-gradient(90deg, rgba(14,165,233,0.28), rgba(34,197,94,0.22));
    color:#fff;
    padding:10px 12px;
    border-radius:999px;
    cursor:pointer;
    font-weight:900;
    min-width:44px;
    text-align:center;
  }
  .menu{
    position:absolute; right:0; top:48px;
    width: 240px;
    background: var(--card);
    color: var(--text);
    border:1px solid var(--line);
    border-radius:14px;
    box-shadow: var(--shadow);
    padding:10px;
    display:none;
    z-index:1000;
  }
  .menu.open{ display:block; }
  .menuItem{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:12px; }
  .menuItem:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuItem:hover{ background: rgba(255,255,255,0.06); }
  .menuLink{ display:block; padding:10px; border-radius:12px; color:var(--text); text-decoration:none; font-weight:900; }
  .menuLink:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuLink:hover{ background: rgba(255,255,255,0.06); }
  .switch{ width:22px; height:22px; accent-color: var(--accent); }

  /* Level row (DAILY XP) */
  .lvlRow{
    display:flex; align-items:center; gap:10px;
    width:320px; max-width:100%;
    justify-content:flex-end;
  }
  .lvlTag{
    font-weight:900; padding:8px 10px;
    border-radius:999px;
    background: var(--hudBg);
    border:1px solid var(--hudBorder);
    white-space:nowrap;
  }
  .barWrap{
    flex:1; height:14px;
    border-radius:999px; overflow:hidden;
    background: var(--hudBg);
    border:1px solid var(--hudBorder);
  }
  .barFill{
    width:0%; height:100%;
    background: linear-gradient(90deg,var(--hud1),var(--hud2));
    transition: width 180ms ease;
  }
  .barText{ font-weight:900; font-size:12px; white-space:nowrap; opacity:0.95; }

  /* Streak row */
  .streakRow{
    display:flex; align-items:center; gap:10px;
    width:320px; max-width:100%;
    justify-content:flex-end;
  }
  .streakTag{
    font-weight:900;
    padding:6px 10px;
    border-radius:999px;
    background: rgba(249,115,22,0.22);
    border:1px solid rgba(249,115,22,0.35);
    white-space:nowrap;
  }
  .streakWrap{
    flex:1; height:10px;
    border-radius:999px; overflow:hidden;
    background: rgba(249,115,22,0.12);
    border:1px solid rgba(249,115,22,0.25);
  }
  .streakFill{
    width:0%; height:100%;
    background: linear-gradient(90deg,#f97316,#facc15);
    transition: width 200ms ease;
  }

  /* GP pill */
  .gpRow{ display:flex; justify-content:flex-end; width:320px; max-width:100%; }
  .pill{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    border-radius:999px;
    background: var(--hudBg);
    border:1px solid var(--hudBorder);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    font-weight:900;
    width: fit-content;
  }
  .pill small{ opacity:0.9; font-weight:800; }

  .page{ max-width:1100px; margin:0 auto; padding:16px; }
  .card{
    background: var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:14px;
    margin-bottom:14px;
  }
  h2{ margin:0 0 10px 0; font-size:16px; letter-spacing:0.2px; }
  .muted{ color:var(--muted); font-size:12px; }

  .row{
    display:flex; align-items:flex-start; justify-content:space-between;
    gap:10px; padding:10px 0;
    border-bottom:1px solid var(--line);
  }
  .row:last-child{ border-bottom:none; }
  .left{ display:flex; align-items:flex-start; gap:10px; flex:1; min-width:0; }
  .cb{ width:22px; height:22px; accent-color: var(--accent); flex-shrink:0; margin-top:2px; }
  .text{ white-space: normal; word-break: break-word; line-height:1.25; }
  .done{ text-decoration: line-through; opacity:0.55; }
  .right{ display:flex; gap:8px; flex-shrink:0; align-items:flex-start; }

  button{
    padding:10px 12px; border:none; border-radius:12px;
    cursor:pointer; font-weight:900; color:#fff;
    background: linear-gradient(90deg,var(--accent),#16a34a);
  }
  .xBtn{
    width:34px; height:34px; border-radius:999px;
    padding:0; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(90deg,var(--danger),#dc2626);
    font-size:18px; line-height:1;
  }

  input, select{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: transparent;
    color: var(--text);
    outline:none;
  }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .grid3{ display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; }

  .catBlock{ border:1px solid var(--line); border-radius:12px; padding:12px; margin-bottom:12px; }
  .catHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
  .catTitle{ font-weight:900; letter-spacing:0.2px; }

  .rewardRow{
    border-radius:12px; padding:10px 12px; margin-bottom:10px;
    border:1px solid var(--line);
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .rewardLeft{ display:flex; gap:10px; align-items:flex-start; flex:1; min-width:0; }
  .buyBtn{ min-width:84px; text-align:center; }
  .rewardGlow{
    box-shadow: 0 0 0 2px rgba(34,197,94,.25), 0 0 22px rgba(34,197,94,.30);
    animation: pulse 1.6s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{ box-shadow: 0 0 0 2px rgba(34,197,94,.18), 0 0 14px rgba(34,197,94,.18); }
    50%{ box-shadow: 0 0 0 2px rgba(34,197,94,.35), 0 0 28px rgba(34,197,94,.32); }
    100%{ box-shadow: 0 0 0 2px rgba(34,197,94,.18), 0 0 14px rgba(34,197,94,.18); }
  }

  .tableWrap{ width:100%; overflow:auto; border:1px solid var(--line); border-radius:12px; }
  table{ width:100%; border-collapse: collapse; min-width: 820px; }
  th, td{ border-bottom:1px solid var(--line); padding:10px; vertical-align: top; text-align:left; }
  th{ position: sticky; top: 0; background: var(--card); z-index:2; font-size:12px; color:var(--muted); letter-spacing:0.3px; }
  .taskCol{ min-width:220px; font-weight:900; }
  .ptsCol{ width:90px; font-weight:900; white-space:nowrap; }
  .dayCell{ width:90px; text-align:center; }
  .dayCell input{ width:22px; height:22px; accent-color: var(--accent); }

  /* phone HUD smaller */
  @media (max-width: 720px){
    .lvlRow, .streakRow, .gpRow{ width: 210px; }
    .lvlTag{ padding:5px 7px; font-size:11px; }
    .barWrap{ height:8px; }
    .barText{ font-size:10px; }

    .streakTag{ padding:4px 6px; font-size:10px; }
    .streakWrap{ height:6px; }

    .menu{ top:54px; width:210px; }
    .tabBtn{ padding:9px 10px; }
  }
</style>
</head>

<body>

<div class="topbar">
  <div class="topbarInner">
    <div class="leftTop">
      <div class="appTitle">Quest Tracker</div>
      <div class="tabs">
        <button class="tabBtn active" id="tabTasks" onclick="Tabs.set('tasks')">Tasks</button>
        <button class="tabBtn" id="tabDaily" onclick="Tabs.set('daily')">Daily</button>
        <button class="tabBtn" id="tabRewards" onclick="Tabs.set('rewards')">Rewards</button>
      </div>
    </div>

    <div class="hud">
      <div class="menuWrap">
        <button class="menuBtn" id="menuBtn" aria-haspopup="true" aria-expanded="false">‚ò∞</button>
        <div class="menu" id="menu">
          <div class="menuItem">
            <span style="font-weight:900;">Darkmode</span>
            <input class="switch" type="checkbox" id="darkToggle">
          </div>
          <a class="menuLink" href="./finances.html">Finances</a>
          <a class="menuLink" href="./jobs.html">Jobs</a>
          <a class="menuLink" href="./statistics.html">Statistics</a>
          <a class="menuLink" href="./workout.html">Workout</a>
        </div>
      </div>

      <!-- LEVEL = DAILY XP -->
      <div class="lvlRow">
        <div class="lvlTag" id="lvlTag">LVL 1</div>
        <div class="barWrap"><div class="barFill" id="barFill"></div></div>
        <div class="barText" id="barText">0/50</div>
      </div>

      <!-- STREAK = DAILY ONLY -->
      <div class="streakRow">
        <div class="streakTag" id="streakTag">üî• 0 Day Streak</div>
        <div class="streakWrap"><div class="streakFill" id="streakFill"></div></div>
      </div>

      <div class="gpRow">
        <div class="pill"><small>GP</small> <span id="gpVal">0</span></div>
      </div>
    </div>
  </div>
</div>

<div class="page">

  <!-- TASKS -->
  <div id="viewTasks">
    <div class="card">
      <h2>Tasks</h2>
      <div id="tasksByCat"></div>
      <div class="muted">Completed tasks disappear after 5 minutes.</div>
    </div>

    <div class="card">
      <h2>Add Task</h2>
      <div class="grid3">
        <input id="newTaskName" placeholder="Task name" />
        <input id="newTaskPts" type="number" placeholder="GP" />
        <select id="newTaskCat"></select>
      </div>
      <div style="margin-top:10px;">
        <button onclick="Tasks.add()">Add Task</button>
      </div>

      <div style="margin-top:14px;">
        <div class="grid2">
          <input id="newCatName" placeholder="New category name" />
          <button onclick="Categories.add()">Add Category</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DAILY -->
  <div id="viewDaily" style="display:none;">
    <div class="card">
      <h2>Weekly Daily Tasks</h2>
      <div class="tableWrap">
        <table id="dailyTable"></table>
      </div>
      <div class="muted">Streak increases only when ALL daily tasks for a day are completed.</div>
    </div>

    <div class="card">
      <h2>Add Daily Task Row</h2>
      <div class="grid3">
        <input id="newDailyName" placeholder="Daily task name" />
        <input id="newDailyPts" type="number" placeholder="GP per check" />
        <select id="newDailyIsGym">
          <option value="0">Normal</option>
          <option value="1">Gym</option>
        </select>
      </div>
      <div style="margin-top:10px;">
        <button onclick="Daily.addRow()">Add</button>
      </div>
    </div>
  </div>

  <!-- REWARDS -->
  <div id="viewRewards" style="display:none;">
    <div class="card">
      <h2>Rewards</h2>
      <div id="rewardsList"></div>
      <div class="muted">Rewards glow when you can afford them.</div>
    </div>

    <div class="card">
      <h2>Add Reward</h2>
      <div class="grid3">
        <input id="newRewardName" placeholder="Reward name" />
        <input id="newRewardCost" type="number" placeholder="Cost (GP)" />
        <button onclick="Rewards.add()">Add</button>
      </div>
    </div>
  </div>

</div>

<script>
/* =========================================================
  BLOCK 0 ‚Äî STORAGE + TIME HELPERS (PHONE LOCAL TIME)
========================================================= */
const LS = {
  get(key, fallback){
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  },
  set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
};
function uuid(){
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2);
}
function clamp0(n){ return n < 0 ? 0 : n; }

function localDateKey(d=new Date()){
  // phone local date as YYYY-MM-DD
  const yr = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${yr}-${mo}-${da}`;
}
function startOfWeekMonday(d){
  const x = new Date(d);
  const day = x.getDay(); // 0 Sun..6 Sat
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  x.setHours(0,0,0,0);
  return x;
}
function weekKeyFor(d){
  const m = startOfWeekMonday(d);
  return localDateKey(m);
}
function dayIndexMon0(d){
  const day = d.getDay();
  return (day === 0) ? 6 : (day - 1); // Mon=0..Sun=6
}

/* =========================================================
  BLOCK 1 ‚Äî EVENT LOG (FOR STATISTICS)
========================================================= */
const Log = (() => {
  let events = LS.get("eventLog_v1", []);
  function add(evt){
    // evt: {ts, kind, action, gp, dailyXP, meta}
    events.push(evt);
    // keep last 180 days to avoid bloat
    const cutoff = Date.now() - 180*24*60*60*1000;
    events = events.filter(e => e.ts >= cutoff);
    LS.set("eventLog_v1", events);
  }
  function list(){ return events; }
  return { add, list };
})();

/* =========================================================
  BLOCK 2 ‚Äî ECONOMY
  GP = spendable
  DAILY_XP = level XP (ONLY from Daily)
========================================================= */
const Economy = (() => {
  let gp = LS.get("gp", 0);
  let dailyXP = LS.get("dailyXP", 0);

  function xpToNext(level){ return 50 + (level - 1) * 25; }
  function computeLevel(xp){
    let level = 1;
    let rem = xp;
    while(true){
      const need = xpToNext(level);
      if (rem < need) return { level, inLevel: rem, need };
      rem -= need;
      level++;
    }
  }

  function addGP(pts, meta={}){
    pts = Number(pts) || 0;
    gp = clamp0(gp + pts);
    persist();
    UI.renderHeader();
    Log.add({ ts: Date.now(), kind:"gp", action:"add", gp: pts, dailyXP: 0, meta });
  }
  function removeGP(pts, meta={}){
    pts = Number(pts) || 0;
    gp = clamp0(gp - pts);
    persist();
    UI.renderHeader();
    Log.add({ ts: Date.now(), kind:"gp", action:"remove", gp: pts, dailyXP: 0, meta });
  }

  // Daily completion: earns GP + DailyXP
  function addDaily(pts, meta={}){
    pts = Number(pts) || 0;
    gp = clamp0(gp + pts);
    dailyXP = clamp0(dailyXP + pts);
    persist();
    UI.renderHeader();
    Log.add({ ts: Date.now(), kind:"daily", action:"check", gp: pts, dailyXP: pts, meta });
  }
  function removeDaily(pts, meta={}){
    pts = Number(pts) || 0;
    gp = clamp0(gp - pts);
    dailyXP = clamp0(dailyXP - pts);
    persist();
    UI.renderHeader();
    Log.add({ ts: Date.now(), kind:"daily", action:"uncheck", gp: pts, dailyXP: pts, meta });
  }

  function spend(cost, meta={}){
    cost = Number(cost) || 0;
    if (gp < cost) return false;
    gp = clamp0(gp - cost);
    persist();
    UI.renderHeader();
    Log.add({ ts: Date.now(), kind:"gp", action:"spend", gp: cost, dailyXP: 0, meta });
    return true;
  }

  function getGP(){ return gp; }
  function getDailyXP(){ return dailyXP; }

  function persist(){
    LS.set("gp", gp);
    LS.set("dailyXP", dailyXP);
  }

  return { addGP, removeGP, addDaily, removeDaily, spend, getGP, getDailyXP, computeLevel };
})();

/* =========================================================
  BLOCK 3 ‚Äî THEME + MENU
========================================================= */
const Theme = (() => {
  const darkToggle = document.getElementById("darkToggle");
  function apply(theme){
    document.documentElement.setAttribute("data-theme", theme);
    LS.set("theme", theme);
    darkToggle.checked = (theme === "dark");
  }
  function init(){
    apply(LS.get("theme", "light"));
    darkToggle.addEventListener("change", () => apply(darkToggle.checked ? "dark" : "light"));
  }
  return { init };
})();

const Menu = (() => {
  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");
  function setOpen(open){
    if (open){ menu.classList.add("open"); menuBtn.setAttribute("aria-expanded","true"); }
    else { menu.classList.remove("open"); menuBtn.setAttribute("aria-expanded","false"); }
  }
  function init(){
    menuBtn.addEventListener("click", (e) => { e.stopPropagation(); setOpen(!menu.classList.contains("open")); });
    document.addEventListener("click", () => setOpen(false));
  }
  return { init };
})();

/* =========================================================
  BLOCK 4 ‚Äî TABS
========================================================= */
const Tabs = (() => {
  let current = LS.get("tab", "tasks");
  function set(tab){
    current = tab; LS.set("tab", tab);
    document.getElementById("viewTasks").style.display = (tab === "tasks") ? "" : "none";
    document.getElementById("viewDaily").style.display = (tab === "daily") ? "" : "none";
    document.getElementById("viewRewards").style.display = (tab === "rewards") ? "" : "none";
    document.getElementById("tabTasks").classList.toggle("active", tab === "tasks");
    document.getElementById("tabDaily").classList.toggle("active", tab === "daily");
    document.getElementById("tabRewards").classList.toggle("active", tab === "rewards");
  }
  function init(){ set(current); }
  return { init, set };
})();

/* =========================================================
  BLOCK 5 ‚Äî UI (HEADER)
========================================================= */
const UI = (() => {
  function renderHeader(){
    document.getElementById("gpVal").textContent = Economy.getGP();
    const lvl = Economy.computeLevel(Economy.getDailyXP());
    document.getElementById("lvlTag").textContent = `LVL ${lvl.level}`;
    const pct = Math.max(0, Math.min(100, (lvl.inLevel / lvl.need) * 100));
    document.getElementById("barFill").style.width = pct.toFixed(1) + "%";
    document.getElementById("barText").textContent = `${lvl.inLevel}/${lvl.need}`;
  }
  function renderStreak(streak){
    document.getElementById("streakTag").textContent = `üî• ${streak} Day Streak`;
    const pct = Math.min(100, (streak / 14) * 100); // bar fills at 14 days (change if you want)
    document.getElementById("streakFill").style.width = pct + "%";
  }
  return { renderHeader, renderStreak };
})();

/* =========================================================
  BLOCK 6 ‚Äî TASKS + CATEGORIES (TASKS ONLY GIVE GP)
========================================================= */
const TasksConfig = { HIDE_AFTER_MS: 5 * 60 * 1000 };

const Categories = (() => {
  let categories = LS.get("categories_v0", [{ id: "cat_general", name: "General" }]);
  function list(){ return categories; }
  function persist(){ LS.set("categories_v0", categories); }

  function add(){
    const name = document.getElementById("newCatName").value.trim();
    if (!name) return alert("Enter a category name.");
    const id = "cat_" + name.toLowerCase().replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
    if (categories.some(c => c.id === id)) return alert("Category already exists.");

    categories.push({ id, name });
    persist();
    document.getElementById("newCatName").value = "";
    Tasks.renderCategorySelect();
    Tasks.render();
  }

  function remove(catId){
    if (catId === "cat_general") return alert("You can‚Äôt delete General.");
    Tasks.moveTasksToGeneral(catId);
    categories = categories.filter(c => c.id !== catId);
    persist();
    Tasks.renderCategorySelect();
    Tasks.render();
  }

  return { list, add, remove };
})();

const Tasks = (() => {
  let tasks = LS.get("tasks_v0", []); // empty by default
  function persist(){ LS.set("tasks_v0", tasks); }

  function renderCategorySelect(){
    const sel = document.getElementById("newTaskCat");
    sel.innerHTML = "";
    Categories.list().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id; opt.textContent = c.name;
      sel.appendChild(opt);
    });
  }

  function moveTasksToGeneral(catId){
    tasks.forEach(t => { if (t.catId === catId) t.catId = "cat_general"; });
    persist();
  }

  function isHiddenByTimer(task){
    if (!task.done || !task.doneAt) return false;
    return (Date.now() - task.doneAt) >= TasksConfig.HIDE_AFTER_MS;
  }
  function scheduleAutoHide(task){
    if (!task.done || !task.doneAt) return;
    const remaining = TasksConfig.HIDE_AFTER_MS - (Date.now() - task.doneAt);
    if (remaining <= 0) return;
    setTimeout(() => {
      const t = tasks.find(x => x.id === task.id);
      if (t && t.done && isHiddenByTimer(t)) render();
    }, remaining + 20);
  }

  function add(){
    const name = document.getElementById("newTaskName").value.trim();
    const pts = parseInt(document.getElementById("newTaskPts").value, 10);
    const catId = document.getElementById("newTaskCat").value;
    if (!name || Number.isNaN(pts)) return alert("Add task name + GP.");
    if (!catId) return alert("Choose a category.");
    tasks.push({ id: uuid(), name, pts, done:false, catId, doneAt:null });
    persist();
    document.getElementById("newTaskName").value = "";
    document.getElementById("newTaskPts").value = "";
    render();
  }

  function remove(taskId){
    const t = tasks.find(x => x.id === taskId);
    if (!t) return;
    if (t.done) Economy.removeGP(t.pts, {source:"task_delete", taskId});
    tasks = tasks.filter(x => x.id !== taskId);
    persist();
    render();
    Rewards.render();
  }

  function toggleDone(taskId, checked){
    const t = tasks.find(x => x.id === taskId);
    if (!t) return;

    if (checked && !t.done){
      Economy.addGP(t.pts, {source:"task_check", taskId});
      t.done = true;
      t.doneAt = Date.now();
      Log.add({ ts: Date.now(), kind:"task", action:"complete", gp: t.pts, dailyXP: 0, meta: { catId: t.catId, taskName: t.name } });
      scheduleAutoHide(t);
    } else if (!checked && t.done){
      Economy.removeGP(t.pts, {source:"task_uncheck", taskId});
      t.done = false;
      t.doneAt = null;
      Log.add({ ts: Date.now(), kind:"task", action:"undo", gp: t.pts, dailyXP: 0, meta: { catId: t.catId, taskName: t.name } });
    }

    persist();
    render();
    Rewards.render();
  }

  function render(){
    const host = document.getElementById("tasksByCat");
    host.innerHTML = "";

    Categories.list().forEach(cat => {
      const block = document.createElement("div");
      block.className = "catBlock";

      const header = document.createElement("div");
      header.className = "catHeader";

      const title = document.createElement("div");
      title.className = "catTitle";
      title.textContent = cat.name;
      header.appendChild(title);

      if (cat.id !== "cat_general"){
        const x = document.createElement("button");
        x.className = "xBtn"; x.textContent = "√ó"; x.title="Delete category";
        x.addEventListener("click", () => Categories.remove(cat.id));
        header.appendChild(x);
      }

      block.appendChild(header);

      const catTasks = tasks
        .filter(t => t.catId === cat.id)
        .filter(t => !isHiddenByTimer(t));

      if (catTasks.length === 0){
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No tasks here.";
        block.appendChild(empty);
      } else {
        catTasks.forEach(t => {
          scheduleAutoHide(t);

          const row = document.createElement("div");
          row.className = "row";

          const left = document.createElement("div");
          left.className = "left";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "cb";
          cb.checked = !!t.done;
          cb.addEventListener("change", () => toggleDone(t.id, cb.checked));

          const text = document.createElement("div");
          text.className = "text";
          text.textContent = `${t.name} (${t.pts} GP)`;
          if (t.done) text.classList.add("done");

          left.appendChild(cb);
          left.appendChild(text);

          const right = document.createElement("div");
          right.className = "right";

          const x = document.createElement("button");
          x.className = "xBtn";
          x.textContent = "√ó";
          x.title = "Delete task";
          x.addEventListener("click", () => remove(t.id));

          right.appendChild(x);

          row.appendChild(left);
          row.appendChild(right);
          block.appendChild(row);
        });
      }

      host.appendChild(block);
    });
  }

  return { add, render, renderCategorySelect, moveTasksToGeneral };
})();

/* =========================================================
  BLOCK 7 ‚Äî REWARDS
========================================================= */
const Rewards = (() => {
  let rewards = LS.get("rewards_v0", []); // empty by default
  function persist(){ LS.set("rewards_v0", rewards); }

  function add(){
    const name = document.getElementById("newRewardName").value.trim();
    const cost = parseInt(document.getElementById("newRewardCost").value, 10);
    if (!name || Number.isNaN(cost)) return alert("Enter reward name + cost.");

    rewards.push({ id: uuid(), name, cost });
    persist();
    document.getElementById("newRewardName").value = "";
    document.getElementById("newRewardCost").value = "";
    render();
  }

  function remove(id){
    rewards = rewards.filter(r => r.id !== id);
    persist();
    render();
  }

  function buy(id){
    const r = rewards.find(x => x.id === id);
    if (!r) return;
    if (Economy.spend(r.cost, {source:"reward_buy", rewardId:id, rewardName:r.name})){
      alert(`Claimed: ${r.name}`);
      render();
    } else alert("Not enough GP.");
  }

  function render(){
    const host = document.getElementById("rewardsList");
    host.innerHTML = "";

    if (rewards.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No rewards yet. Add one below.";
      host.appendChild(empty);
      return;
    }

    rewards.forEach(r => {
      const row = document.createElement("div");
      row.className = "rewardRow";
      if (Economy.getGP() >= Number(r.cost)) row.classList.add("rewardGlow");

      const left = document.createElement("div");
      left.className = "rewardLeft";

      const buyBtn = document.createElement("button");
      buyBtn.className = "buyBtn";
      buyBtn.textContent = "Buy";
      buyBtn.addEventListener("click", () => buy(r.id));

      const text = document.createElement("div");
      text.className = "text";
      text.textContent = `${r.name} (Cost: ${r.cost} GP)`;

      left.appendChild(buyBtn);
      left.appendChild(text);

      const right = document.createElement("div");
      right.className = "right";

      const x = document.createElement("button");
      x.className = "xBtn"; x.textContent = "√ó"; x.title="Delete reward";
      x.addEventListener("click", () => remove(r.id));
      right.appendChild(x);

      row.appendChild(left);
      row.appendChild(right);
      host.appendChild(row);
    });
  }

  return { add, render };
})();

/* =========================================================
  BLOCK 8 ‚Äî DAILY (WEEK TABLE + STREAK RULES)
  - daily row has {isGym}
  - checking daily gives GP + DAILY XP
========================================================= */
const Daily = (() => {
  let rows = LS.get("dailyRows_v0", []);        // user-defined
  let checks = LS.get("dailyChecks_v0", {});    // per-week checkbox grid

  function persistRows(){ LS.set("dailyRows_v0", rows); }
  function persistChecks(){ LS.set("dailyChecks_v0", checks); }

  function ensureWeek(weekKey){
    if (!checks[weekKey]) checks[weekKey] = {};
    for (const row of rows){
      if (!checks[weekKey][row.id]){
        checks[weekKey][row.id] = { 0:false,1:false,2:false,3:false,4:false,5:false,6:false };
      }
    }
    persistChecks();
  }

  function addRow(){
    const name = document.getElementById("newDailyName").value.trim();
    const pts = parseInt(document.getElementById("newDailyPts").value, 10);
    const isGym = document.getElementById("newDailyIsGym").value === "1";
    if (!name || Number.isNaN(pts)) return alert("Add daily name + GP.");

    const row = { id: uuid(), name, pts, isGym };
    rows.push(row);
    persistRows();

    // ensure this week has keys
    const wk = weekKeyFor(new Date());
    ensureWeek(wk);
    checks[wk][row.id] = { 0:false,1:false,2:false,3:false,4:false,5:false,6:false };
    persistChecks();

    document.getElementById("newDailyName").value = "";
    document.getElementById("newDailyPts").value = "";
    document.getElementById("newDailyIsGym").value = "0";

    render();
  }

  function removeRow(rowId){
    // reverse any checked boxes in current week (net)
    const now = new Date();
    const wk = weekKeyFor(now);
    ensureWeek(wk);
    const row = rows.find(r => r.id === rowId);
    if (row){
      const weekGrid = checks[wk][rowId] || {};
      let count = 0;
      for (let i=0;i<7;i++) if (weekGrid[i]) count++;
      if (count > 0){
        Economy.removeDaily(count * row.pts, {source:"daily_row_delete", rowId, rowName: row.name});
      }
    }

    rows = rows.filter(r => r.id !== rowId);
    persistRows();

    // remove from all weeks
    Object.keys(checks).forEach(wkKey => { if (checks[wkKey]) delete checks[wkKey][rowId]; });
    persistChecks();

    render();
    Rewards.render();
    Streak.evaluateAndRender(); // could affect "all completed" logic
  }

  function toggle(rowId, dayIndex, nowChecked){
    const now = new Date();
    const wk = weekKeyFor(now);
    ensureWeek(wk);

    const row = rows.find(r => r.id === rowId);
    if (!row) return;

    const was = !!checks[wk][rowId][dayIndex];

    if (nowChecked && !was){
      checks[wk][rowId][dayIndex] = true;
      persistChecks();

      Economy.addDaily(row.pts, {source:"daily_check", rowId, rowName: row.name, dayIndex, weekKey: wk, isGym: row.isGym});
      Log.add({ ts: Date.now(), kind:"daily_task", action:"check", gp: row.pts, dailyXP: row.pts, meta: { rowId, rowName: row.name, dayIndex, weekKey: wk, isGym: row.isGym } });

    } else if (!nowChecked && was){
      checks[wk][rowId][dayIndex] = false;
      persistChecks();

      Economy.removeDaily(row.pts, {source:"daily_uncheck", rowId, rowName: row.name, dayIndex, weekKey: wk, isGym: row.isGym});
      Log.add({ ts: Date.now(), kind:"daily_task", action:"uncheck", gp: row.pts, dailyXP: row.pts, meta: { rowId, rowName: row.name, dayIndex, weekKey: wk, isGym: row.isGym } });
    }

    Rewards.render();
    Streak.evaluateAndRender();
  }

  function allDailyCompletedForDate(dateObj){
    if (rows.length === 0) return false; // no dailies => no streak
    const wk = weekKeyFor(dateObj);
    ensureWeek(wk);
    const idx = dayIndexMon0(dateObj);

    for (const row of rows){
      const cell = checks[wk]?.[row.id]?.[idx];
      if (!cell) return false;
    }
    return true;
  }

  function render(){
    const now = new Date();
    const wk = weekKeyFor(now);
    ensureWeek(wk);

    const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const table = document.getElementById("dailyTable");
    table.innerHTML = "";

    const thead = document.createElement("thead");
    const hr = document.createElement("tr");
    hr.innerHTML =
      `<th class="taskCol">Daily Task</th><th class="ptsCol">GP</th>` +
      days.map(d => `<th class="dayCell">${d}</th>`).join("") +
      `<th></th>`;
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    if (rows.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" class="muted">No daily rows yet. Add one below.</td>`;
      tbody.appendChild(tr);
      table.appendChild(tbody);
      return;
    }

    rows.forEach(row => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.className = "taskCol";
      tdName.textContent = row.isGym ? `üèãÔ∏è ${row.name}` : row.name;

      const tdPts = document.createElement("td");
      tdPts.className = "ptsCol";
      tdPts.textContent = `${row.pts}`;

      tr.appendChild(tdName);
      tr.appendChild(tdPts);

      for (let i=0;i<7;i++){
        const td = document.createElement("td");
        td.className = "dayCell";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!checks[wk][row.id][i];
        cb.addEventListener("change", () => toggle(row.id, i, cb.checked));

        td.appendChild(cb);
        tr.appendChild(td);
      }

      const tdDel = document.createElement("td");
      tdDel.style.textAlign = "right";

      const x = document.createElement("button");
      x.className = "xBtn";
      x.textContent = "√ó";
      x.title = "Delete daily row";
      x.addEventListener("click", () => removeRow(row.id));

      tdDel.appendChild(x);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
  }

  return { addRow, render, allDailyCompletedForDate };
})();

/* =========================================================
  BLOCK 9 ‚Äî STREAK SYSTEM (DAILY ONLY)
  Rule:
  - If ALL daily tasks for a day are completed by end of that day -> streak +1
  - Else -> streak reset to 0
  - Evaluates automatically on date change (phone local time)
========================================================= */
const Streak = (() => {
  let streak = LS.get("dailyStreak_v1", 0);
  let lastEvaluatedDate = LS.get("streakLastEvalDate_v1", null); // YYYY-MM-DD

  function persist(){
    LS.set("dailyStreak_v1", streak);
    LS.set("streakLastEvalDate_v1", lastEvaluatedDate);
  }

  function evaluateDay(dateObj){
    const ok = Daily.allDailyCompletedForDate(dateObj);
    if (ok) streak += 1;
    else streak = 0;
  }

  function evaluateAndRender(){
    const todayKey = localDateKey(new Date());

    // First run: set baseline to today (no backfill)
    if (!lastEvaluatedDate){
      lastEvaluatedDate = todayKey;
      persist();
      UI.renderStreak(streak);
      return;
    }

    // If date changed since last evaluation, evaluate the day(s) that passed.
    if (todayKey !== lastEvaluatedDate){
      // evaluate previous day for each day skipped
      let cursor = new Date(lastEvaluatedDate + "T12:00:00"); // midday avoids DST edge
      let today = new Date(todayKey + "T12:00:00");

      while (cursor < today){
        // move cursor one day forward, then evaluate the day we just left behind
        const prev = new Date(cursor);
        // evaluate "prev day" itself at boundary
        evaluateDay(prev);

        cursor.setDate(cursor.getDate() + 1);
      }

      lastEvaluatedDate = todayKey;
      persist();
    }

    UI.renderStreak(streak);
  }

  function initAutoTick(){
    // check every 30 seconds for date change (cheap)
    setInterval(() => evaluateAndRender(), 30 * 1000);
  }

  return { evaluateAndRender, initAutoTick };
})();

/* =========================================================
  APP INIT
========================================================= */
(function AppInit(){
  Theme.init();
  Menu.init();
  Tabs.init();

  UI.renderHeader();

  Tasks.renderCategorySelect();
  Tasks.render();
  Daily.render();
  Rewards.render();

  Streak.evaluateAndRender();
  Streak.initAutoTick();
})();
</script>

</body>
</html>

