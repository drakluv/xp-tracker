<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Quest Tracker</title>

<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:rgba(0,0,0,0.10);

    --primary:#7c3aed;
    --primary2:#2563eb;
    --accent:#22c55e;
    --danger:#ef4444;

    --shadow:0 10px 30px rgba(0,0,0,0.12);
    --radius:14px;
  }
  [data-theme="dark"]{
    --bg:#0b1220;
    --card:#111a2e;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:rgba(255,255,255,0.12);
    --shadow:0 10px 30px rgba(0,0,0,0.45);
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* Sticky top bar */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 999;
    padding: 14px 14px;
    background: linear-gradient(90deg, var(--primary), var(--primary2));
    color:#fff;
    box-shadow: var(--shadow);
  }
  .topbarInner{
    max-width: 1100px;
    margin: 0 auto;
    display:flex;
    align-items:stretch;
    justify-content:space-between;
    gap:12px;
  }
  .leftTop{
    flex:1;
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .appTitle{
    font-weight: 900;
    font-size: 18px;
    letter-spacing: 0.2px;
    margin:0;
  }

  .tabs{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .tabBtn{
    border:1px solid rgba(255,255,255,0.28);
    background: rgba(255,255,255,0.16);
    color:#fff;
    padding:10px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 900;
  }
  .tabBtn.active{
    background: rgba(255,255,255,0.30);
    border-color: rgba(255,255,255,0.45);
  }

  .rightTop{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:10px;
    flex-shrink:0;
  }
  .statsRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .pill{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:999px;
    background: rgba(255,255,255,0.16);
    border:1px solid rgba(255,255,255,0.22);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    font-weight:900;
  }
  .pill small{ opacity:0.9; font-weight:800; }

  .lvlRow{
    display:flex;
    align-items:center;
    gap:10px;
    width: 320px;
    max-width: 100%;
  }
  .lvlTag{
    font-weight: 900;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(0,0,0,0.20);
    border:1px solid rgba(255,255,255,0.20);
    white-space:nowrap;
  }
  .barWrap{
    flex:1;
    height: 14px;
    border-radius: 999px;
    overflow:hidden;
    background: rgba(255,255,255,0.18);
    border:1px solid rgba(255,255,255,0.22);
  }
  .barFill{
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg,#34d399,#22c55e,#a3e635);
    transition: width 180ms ease;
  }
  /* 4) bar text like 30/50 */
  .barText{
    font-weight: 900;
    font-size: 12px;
    white-space:nowrap;
    opacity: 0.95;
  }

  /* Menu */
  .menuWrap{ position:relative; }
  .menuBtn{
    border:1px solid rgba(255,255,255,0.28);
    background: rgba(255,255,255,0.16);
    color:#fff;
    padding:10px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 900;
    min-width: 44px;
    text-align:center;
  }
  .menu{
    position:absolute;
    right:0;
    top:48px;
    width: 220px;
    background: var(--card);
    color: var(--text);
    border:1px solid var(--line);
    border-radius: 14px;
    box-shadow: var(--shadow);
    padding: 10px;
    display:none;
    z-index: 1000;
  }
  .menu.open{ display:block; }
  .menuItem{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border-radius: 12px;
  }
  .menuItem:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuItem:hover{ background: rgba(255,255,255,0.06); }

  .menuLink{
    display:block;
    padding:10px;
    border-radius: 12px;
    color: var(--text);
    text-decoration:none;
    font-weight: 900;
  }
  .menuLink:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuLink:hover{ background: rgba(255,255,255,0.06); }

  .switch{
    width: 22px;
    height: 22px;
    accent-color: var(--accent);
  }

  /* Page */
  .page{
    max-width: 1100px;
    margin: 0 auto;
    padding: 16px;
  }
  .card{
    background: var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 14px;
    margin-bottom: 14px;
  }
  h2{
    margin:0 0 10px 0;
    font-size: 16px;
    letter-spacing: 0.2px;
  }

  .row{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    padding: 10px 0;
    border-bottom:1px solid var(--line);
  }
  .row:last-child{ border-bottom:none; }

  .left{
    display:flex;
    align-items:flex-start;
    gap:10px;
    flex:1;
    min-width:0;
  }
  .cb{
    width:22px;
    height:22px;
    accent-color: var(--accent);
    flex-shrink:0;
    margin-top: 2px;
  }
  .text{
    white-space: normal;
    word-break: break-word;
    line-height: 1.25;
  }
  .done{
    text-decoration: line-through;
    opacity: 0.55;
  }

  .right{
    display:flex;
    gap:8px;
    flex-shrink:0;
  }

  button{
    padding: 10px 12px;
    border:none;
    border-radius: 12px;
    cursor:pointer;
    font-weight: 900;
    color:#fff;
    background: linear-gradient(90deg,var(--accent),#16a34a);
  }
  button.danger{
    background: linear-gradient(90deg,var(--danger),#dc2626);
  }

  input, select{
    width:100%;
    padding: 12px 12px;
    border-radius: 12px;
    border:1px solid var(--line);
    background: transparent;
    color: var(--text);
    outline:none;
  }

  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .grid3{
    display:grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap:10px;
  }

  .muted{ color: var(--muted); font-size: 12px; }

  /* Category blocks */
  .catBlock{
    border:1px solid var(--line);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
  }
  .catHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom: 8px;
  }
  .catTitle{
    font-weight: 900;
    letter-spacing: 0.2px;
  }

  /* Rewards */
  .rewardRow{
    border-radius: 12px;
    padding: 10px 12px;
    margin-bottom: 10px;
    border:1px solid var(--line);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  .rewardRow:last-child{ margin-bottom:0; }
  .rewardLeft{
    display:flex;
    gap:10px;
    align-items:flex-start;
    flex:1;
    min-width:0;
  }
  .buyBtn{
    min-width: 84px;
    text-align:center;
  }
  .rewardGlow{
    box-shadow: 0 0 0 2px rgba(34,197,94,.25), 0 0 22px rgba(34,197,94,.30);
    animation: pulse 1.6s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{ box-shadow: 0 0 0 2px rgba(34,197,94,.18), 0 0 14px rgba(34,197,94,.18); }
    50%{ box-shadow: 0 0 0 2px rgba(34,197,94,.35), 0 0 28px rgba(34,197,94,.32); }
    100%{ box-shadow: 0 0 0 2px rgba(34,197,94,.18), 0 0 14px rgba(34,197,94,.18); }
  }

  /* Daily table */
  .tableWrap{
    width:100%;
    overflow:auto;
    border:1px solid var(--line);
    border-radius: 12px;
  }
  table{
    width:100%;
    border-collapse: collapse;
    min-width: 820px; /* phone scroll */
  }
  th, td{
    border-bottom:1px solid var(--line);
    padding: 10px;
    vertical-align: top;
    text-align:left;
  }
  th{
    position: sticky;
    top: 0;
    background: var(--card);
    z-index: 2;
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.3px;
  }
  .taskCol{ min-width: 220px; font-weight: 900; }
  .ptsCol{ width: 90px; font-weight: 900; white-space: nowrap; }
  .dayCell{ width: 90px; text-align:center; }
  .dayCell input{ width: 22px; height: 22px; accent-color: var(--accent); }

  @media (max-width: 720px){
    .topbarInner{ flex-direction: column; align-items: stretch; }
    .rightTop{ align-items: stretch; }
    .statsRow{ justify-content: space-between; }
    .lvlRow{ width:100%; }
    .grid2, .grid3{ grid-template-columns: 1fr; }
    .menu{ top: 54px; width: 100%; }
  }
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="leftTop">
        <div class="appTitle">Quest Tracker</div>
        <div class="tabs">
          <button class="tabBtn active" id="tabTasks" onclick="setTab('tasks')">Tasks</button>
          <button class="tabBtn" id="tabDaily" onclick="setTab('daily')">Daily</button>
          <button class="tabBtn" id="tabRewards" onclick="setTab('rewards')">Rewards</button>
        </div>
      </div>

      <div class="rightTop">
        <div class="statsRow">
          <div class="pill"><small>GP</small> <span id="gpVal">0</span></div>
        </div>

        <div class="lvlRow">
          <div class="lvlTag" id="lvlTag">LVL 1</div>
          <div class="barWrap"><div class="barFill" id="barFill"></div></div>
          <div class="barText" id="barText">0/50</div>
        </div>

        <div class="menuWrap">
          <button class="menuBtn" id="menuBtn" aria-haspopup="true" aria-expanded="false">â˜°</button>
          <div class="menu" id="menu">
            <div class="menuItem">
              <span style="font-weight:900;">Darkmode</span>
              <input class="switch" type="checkbox" id="darkToggle">
            </div>
            <a class="menuLink" href="./finances.html">Finances</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page">
    <!-- TASKS TAB -->
    <div id="viewTasks">
      <div class="card">
        <h2>Task Categories</h2>

        <div class="grid2" style="margin-bottom:10px;">
          <input id="newCatName" placeholder="New category name" />
          <button onclick="addCategory()">Add Category</button>
        </div>

        <div class="muted">Tasks are grouped by category. Add categories, then add tasks into them.</div>
      </div>

      <div class="card">
        <h2>Tasks</h2>
        <div id="tasksByCat"></div>
      </div>

      <div class="card">
        <h2>Add Task</h2>
        <div class="grid3">
          <input id="newTaskName" placeholder="Task name" />
          <input id="newTaskPts" type="number" placeholder="GP" />
          <select id="newTaskCat"></select>
        </div>
        <div style="margin-top:10px;">
          <button onclick="addTask()">Add Task</button>
        </div>
      </div>
    </div>

    <!-- DAILY TAB -->
    <div id="viewDaily" style="display:none;">
      <div class="card">
        <h2>Weekly Daily Tasks</h2>
        <div class="tableWrap">
          <table id="dailyTable"></table>
        </div>
      </div>

      <div class="card">
        <h2>Add Daily Task Row</h2>
        <div class="grid3">
          <input id="newDailyName" placeholder="Daily task name" />
          <input id="newDailyPts" type="number" placeholder="GP per check" />
          <button onclick="addDailyRow()">Add</button>
        </div>
      </div>
    </div>

    <!-- REWARDS TAB -->
    <div id="viewRewards" style="display:none;">
      <div class="card">
        <h2>Rewards</h2>
        <div id="rewardsList"></div>
      </div>

      <div class="card">
        <h2>Add Reward</h2>
        <div class="grid3">
          <input id="newRewardName" placeholder="Reward name" />
          <input id="newRewardCost" type="number" placeholder="Cost (GP)" />
          <button onclick="addReward()">Add</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const LS = {
  get(key, fallback){
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  },
  set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
};

// UUID fallback
function uuid(){
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2);
}

/* ---------- Economy ----------
GP = spendable
earnedXP = lifetime for level
*/
let gp = LS.get("gp", 0);
let earnedXP = LS.get("earnedXP", 0);

/* Level curve */
function xpToNext(level){ return 50 + (level - 1) * 25; }
function computeLevel(xp){
  let level = 1;
  let rem = xp;
  while(true){
    const need = xpToNext(level);
    if (rem < need) return { level, inLevel: rem, need };
    rem -= need;
    level++;
  }
}

/* ---------- UI state ---------- */
let currentTab = LS.get("tab", "tasks");

/* ---------- Categories + Tasks ---------- */
let categories = LS.get("categories_v0", [
  { id: "cat_general", name: "General" }
]);

let tasks = LS.get("tasks_v0", [
  { id: uuid(), name: "Book Forklift Licence", pts: 5, done: false, catId: "cat_general" },
  { id: uuid(), name: "Book Working at Heights", pts: 4, done: false, catId: "cat_general" },
  { id: uuid(), name: "Book Confined Spaces", pts: 4, done: false, catId: "cat_general" }
]);

/* ---------- Rewards ---------- */
let rewards = LS.get("rewards_v0", [
  { id: uuid(), name: "Coffee / snack", cost: 10 },
  { id: uuid(), name: "Fun outing", cost: 25 },
  { id: uuid(), name: "Big reward", cost: 50 }
]);

/* ---------- Daily weekly table data ----------
dailyRows = [{id,name,pts}]
dailyChecks = { weekKey: { rowId: {0:true..6:false} } }
*/
let dailyRows = LS.get("dailyRows_v0", [
  { id: uuid(), name: "Gym", pts: 5 },
  { id: uuid(), name: "30 min learning", pts: 4 }
]);
let dailyChecks = LS.get("dailyChecks_v0", {});

/* Week key helper (Monday-based) */
function startOfWeekMonday(d){
  const date = new Date(d);
  const day = date.getDay(); // 0 Sun..6 Sat
  const diff = (day === 0 ? -6 : 1 - day); // move to Monday
  date.setDate(date.getDate() + diff);
  date.setHours(0,0,0,0);
  return date;
}
function weekKeyFor(d){
  const m = startOfWeekMonday(d);
  return m.toISOString().slice(0,10);
}
const weekKey = weekKeyFor(new Date());

function ensureWeek(){
  if (!dailyChecks[weekKey]) dailyChecks[weekKey] = {};
  for (const row of dailyRows){
    if (!dailyChecks[weekKey][row.id]){
      dailyChecks[weekKey][row.id] = { 0:false,1:false,2:false,3:false,4:false,5:false,6:false };
    }
  }
  LS.set("dailyChecks_v0", dailyChecks);
}

/* ---------- Header ---------- */
function renderHeader(){
  document.getElementById("gpVal").textContent = gp;

  const lvl = computeLevel(earnedXP);
  document.getElementById("lvlTag").textContent = `LVL ${lvl.level}`;
  const pct = Math.max(0, Math.min(100, (lvl.inLevel / lvl.need) * 100));
  document.getElementById("barFill").style.width = pct.toFixed(1) + "%";
  document.getElementById("barText").textContent = `${lvl.inLevel}/${lvl.need}`;

  LS.set("gp", gp);
  LS.set("earnedXP", earnedXP);
}

/* ---------- Tabs ---------- */
function setTab(tab){
  currentTab = tab;
  LS.set("tab", tab);

  document.getElementById("viewTasks").style.display = (tab === "tasks") ? "" : "none";
  document.getElementById("viewDaily").style.display = (tab === "daily") ? "" : "none";
  document.getElementById("viewRewards").style.display = (tab === "rewards") ? "" : "none";

  document.getElementById("tabTasks").classList.toggle("active", tab === "tasks");
  document.getElementById("tabDaily").classList.toggle("active", tab === "daily");
  document.getElementById("tabRewards").classList.toggle("active", tab === "rewards");
}

/* ---------- Menu ---------- */
const menuBtn = document.getElementById("menuBtn");
const menu = document.getElementById("menu");

function setMenuOpen(open){
  if (open){
    menu.classList.add("open");
    menuBtn.setAttribute("aria-expanded","true");
  } else {
    menu.classList.remove("open");
    menuBtn.setAttribute("aria-expanded","false");
  }
}
menuBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  setMenuOpen(!menu.classList.contains("open"));
});
document.addEventListener("click", () => setMenuOpen(false));

/* ---------- Darkmode ---------- */
const darkToggle = document.getElementById("darkToggle");
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  LS.set("theme", theme);
  darkToggle.checked = (theme === "dark");
}
darkToggle.addEventListener("change", () => {
  applyTheme(darkToggle.checked ? "dark" : "light");
});

/* ---------- Categories UI ---------- */
function renderCategorySelect(){
  const sel = document.getElementById("newTaskCat");
  sel.innerHTML = "";
  categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    sel.appendChild(opt);
  });
}

function addCategory(){
  const name = document.getElementById("newCatName").value.trim();
  if (!name) return alert("Enter a category name.");

  const id = "cat_" + name.toLowerCase().replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
  if (categories.some(c => c.id === id)) return alert("Category already exists.");

  categories.push({ id, name });
  LS.set("categories_v0", categories);

  document.getElementById("newCatName").value = "";
  renderCategorySelect();
  renderTasksByCategory();
}

/* ---------- Tasks ---------- */
function renderTasksByCategory(){
  const host = document.getElementById("tasksByCat");
  host.innerHTML = "";

  categories.forEach(cat => {
    const block = document.createElement("div");
    block.className = "catBlock";

    const header = document.createElement("div");
    header.className = "catHeader";

    const title = document.createElement("div");
    title.className = "catTitle";
    title.textContent = cat.name;

    header.appendChild(title);
    block.appendChild(header);

    const catTasks = tasks.filter(t => t.catId === cat.id);

    if (catTasks.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No tasks in this category yet.";
      block.appendChild(empty);
    } else {
      catTasks.forEach(t => {
        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "left";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "cb";
        cb.checked = !!t.done;

        const text = document.createElement("div");
        text.className = "text";
        text.textContent = `${t.name} (${t.pts} GP)`;
        if (t.done) text.classList.add("done");

        cb.addEventListener("change", () => {
          if (cb.checked && !t.done){
            gp += Number(t.pts) || 0;
            earnedXP += Number(t.pts) || 0;
            t.done = true;
          } else if (!cb.checked && t.done){
            gp -= Number(t.pts) || 0;
            earnedXP -= Number(t.pts) || 0;
            if (gp < 0) gp = 0;
            if (earnedXP < 0) earnedXP = 0;
            t.done = false;
          }

          LS.set("tasks_v0", tasks);
          renderHeader();
          renderTasksByCategory();
          renderRewards(); // glow may change
        });

        left.appendChild(cb);
        left.appendChild(text);

        const right = document.createElement("div");
        right.className = "right";

        const del = document.createElement("button");
        del.className = "danger";
        del.textContent = "Delete";
        del.addEventListener("click", () => {
          if (t.done){
            gp -= Number(t.pts) || 0;
            earnedXP -= Number(t.pts) || 0;
            if (gp < 0) gp = 0;
            if (earnedXP < 0) earnedXP = 0;
          }
          tasks = tasks.filter(x => x.id !== t.id);
          LS.set("tasks_v0", tasks);
          renderHeader();
          renderTasksByCategory();
          renderRewards();
        });

        right.appendChild(del);

        row.appendChild(left);
        row.appendChild(right);
        block.appendChild(row);
      });
    }

    host.appendChild(block);
  });
}

function addTask(){
  const name = document.getElementById("newTaskName").value.trim();
  const pts = parseInt(document.getElementById("newTaskPts").value, 10);
  const catId = document.getElementById("newTaskCat").value;

  if (!name || Number.isNaN(pts)) return alert("Add task name + GP.");
  if (!catId) return alert("Choose a category.");

  tasks.push({ id: uuid(), name, pts, done:false, catId });
  LS.set("tasks_v0", tasks);

  document.getElementById("newTaskName").value = "";
  document.getElementById("newTaskPts").value = "";
  renderTasksByCategory();
}

/* ---------- Rewards ---------- */
function renderRewards(){
  const host = document.getElementById("rewardsList");
  host.innerHTML = "";

  rewards.forEach(r => {
    const row = document.createElement("div");
    row.className = "rewardRow";
    if (gp >= Number(r.cost)) row.classList.add("rewardGlow");

    const left = document.createElement("div");
    left.className = "rewardLeft";

    const buy = document.createElement("button");
    buy.className = "buyBtn";
    buy.textContent = "Buy";
    buy.addEventListener("click", () => {
      const cost = Number(r.cost) || 0;
      if (gp >= cost){
        gp -= cost; // GP only, level stays (earnedXP unchanged)
        renderHeader();
        renderRewards();
        alert(`Claimed: ${r.name}`);
      } else {
        alert("Not enough GP.");
      }
    });

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = `${r.name} (Cost: ${r.cost} GP)`;

    left.appendChild(buy);
    left.appendChild(text);

    const right = document.createElement("div");
    right.className = "right";

    const del = document.createElement("button");
    del.className = "danger";
    del.textContent = "Delete";
    del.addEventListener("click", () => {
      rewards = rewards.filter(x => x.id !== r.id);
      LS.set("rewards_v0", rewards);
      renderRewards();
    });

    right.appendChild(del);

    row.appendChild(left);
    row.appendChild(right);
    host.appendChild(row);
  });
}

function addReward(){
  const name = document.getElementById("newRewardName").value.trim();
  const cost = parseInt(document.getElementById("newRewardCost").value, 10);
  if (!name || Number.isNaN(cost)) return alert("Enter reward name + cost.");

  rewards.push({ id: uuid(), name, cost });
  LS.set("rewards_v0", rewards);

  document.getElementById("newRewardName").value = "";
  document.getElementById("newRewardCost").value = "";
  renderRewards();
}

/* ---------- Daily ---------- */
function renderDailyTable(){
  ensureWeek();

  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const table = document.getElementById("dailyTable");
  table.innerHTML = "";

  const thead = document.createElement("thead");
  const hr = document.createElement("tr");
  hr.innerHTML = `<th class="taskCol">Daily Task</th><th class="ptsCol">GP</th>` + days.map(d => `<th class="dayCell">${d}</th>`).join("") + `<th></th>`;
  thead.appendChild(hr);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");

  dailyRows.forEach(row => {
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.className = "taskCol";
    tdName.textContent = row.name;

    const tdPts = document.createElement("td");
    tdPts.className = "ptsCol";
    tdPts.textContent = `${row.pts}`;

    tr.appendChild(tdName);
    tr.appendChild(tdPts);

    for (let i=0;i<7;i++){
      const td = document.createElement("td");
      td.className = "dayCell";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!dailyChecks[weekKey][row.id][i];

      cb.addEventListener("change", () => {
        const was = !!dailyChecks[weekKey][row.id][i];
        const now = cb.checked;

        if (now && !was){
          gp += Number(row.pts) || 0;
          earnedXP += Number(row.pts) || 0;
          dailyChecks[weekKey][row.id][i] = true;
        } else if (!now && was){
          gp -= Number(row.pts) || 0;
          earnedXP -= Number(row.pts) || 0;
          if (gp < 0) gp = 0;
          if (earnedXP < 0) earnedXP = 0;
          dailyChecks[weekKey][row.id][i] = false;
        }

        LS.set("dailyChecks_v0", dailyChecks);
        renderHeader();
        renderRewards();
      });

      td.appendChild(cb);
      tr.appendChild(td);
    }

    const tdDel = document.createElement("td");
    tdDel.style.textAlign = "right";

    const del = document.createElement("button");
    del.className = "danger";
    del.textContent = "Delete";
    del.addEventListener("click", () => {
      const checks = dailyChecks[weekKey][row.id] || {};
      let count = 0;
      for (let i=0;i<7;i++) if (checks[i]) count++;
      const total = count * (Number(row.pts) || 0);

      if (total > 0){
        gp -= total;
        earnedXP -= total;
        if (gp < 0) gp = 0;
        if (earnedXP < 0) earnedXP = 0;
      }

      dailyRows = dailyRows.filter(r => r.id !== row.id);
      delete dailyChecks[weekKey][row.id];

      LS.set("dailyRows_v0", dailyRows);
      LS.set("dailyChecks_v0", dailyChecks);

      renderHeader();
      renderRewards();
      renderDailyTable();
    });

    tdDel.appendChild(del);
    tr.appendChild(tdDel);

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
}

function addDailyRow(){
  const name = document.getElementById("newDailyName").value.trim();
  const pts = parseInt(document.getElementById("newDailyPts").value, 10);
  if (!name || Number.isNaN(pts)) return alert("Add daily name + GP.");

  const row = { id: uuid(), name, pts };
  dailyRows.push(row);
  LS.set("dailyRows_v0", dailyRows);

  ensureWeek();
  dailyChecks[weekKey][row.id] = { 0:false,1:false,2:false,3:false,4:false,5:false,6:false };
  LS.set("dailyChecks_v0", dailyChecks);

  document.getElementById("newDailyName").value = "";
  document.getElementById("newDailyPts").value = "";
  renderDailyTable();
}

/* ---------- Init ---------- */
applyTheme(LS.get("theme", "light"));
setTab(currentTab);

renderHeader();
renderCategorySelect();
renderTasksByCategory();
renderDailyTable();
renderRewards();
</script>
</body>
</html>
