<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Finances</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:rgba(0,0,0,0.10);

    --primary:#7c3aed;
    --primary2:#2563eb;

    --accent:#22c55e;
    --danger:#ef4444;

    --shadow:0 10px 30px rgba(0,0,0,0.12);
    --radius:14px;

    --hudBg: rgba(255,255,255,0.14);
    --hudBorder: rgba(255,255,255,0.22);
  }

  [data-theme="dark"]{
    --bg:#0b1220;
    --card:#111a2e;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:rgba(255,255,255,0.12);
    --shadow:0 10px 30px rgba(0,0,0,0.45);

    --hudBg: rgba(255,255,255,0.10);
    --hudBorder: rgba(255,255,255,0.18);
  }

  *{ box-sizing:border-box; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }

  /* =========================
     TOPBAR + MENU (same style)
  ========================= */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 999;
    padding: 14px 14px;
    background: linear-gradient(90deg, var(--primary), var(--primary2));
    color:#fff;
    box-shadow: var(--shadow);
  }
  .topbarInner{
    max-width: 1100px;
    margin: 0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .title{
    font-weight: 900;
    font-size: 18px;
    letter-spacing: 0.2px;
  }

  .hud{ display:flex; align-items:center; justify-content:flex-end; gap:10px; }
  .menuWrap{ position:relative; }
  .menuBtn{
    border:1px solid var(--hudBorder);
    background: linear-gradient(90deg, rgba(14,165,233,0.28), rgba(34,197,94,0.22));
    color:#fff;
    padding:10px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 900;
    min-width: 44px;
    text-align:center;
  }
  .menu{
    position:absolute;
    right:0;
    top:48px;
    width: 240px;
    background: var(--card);
    color: var(--text);
    border:1px solid var(--line);
    border-radius: 14px;
    box-shadow: var(--shadow);
    padding: 10px;
    display:none;
    z-index: 1000;
  }
  .menu.open{ display:block; }
  .menuItem{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border-radius: 12px;
  }
  .menuItem:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuItem:hover{ background: rgba(255,255,255,0.06); }
  .menuLink{
    display:block;
    padding:10px;
    border-radius: 12px;
    color: var(--text);
    text-decoration:none;
    font-weight: 900;
  }
  .menuLink:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuLink:hover{ background: rgba(255,255,255,0.06); }
  .switch{ width:22px; height:22px; accent-color: var(--accent); }

  /* =========================
     PAGE
  ========================= */
  .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
    margin-bottom:14px;
    box-shadow: var(--shadow);
  }
  .muted{ color:var(--muted); font-size:12px; }

  input, select{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid var(--line);
    background:transparent;
    color:var(--text);
    outline:none;
  }
  button{
    padding:10px 12px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    color:#fff;
    background:linear-gradient(90deg,var(--accent),#16a34a);
  }
  .xBtn{
    width:34px; height:34px;
    border-radius:999px;
    padding:0;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(90deg,var(--danger),#dc2626);
    font-size:18px;
  }

  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .grid4{ display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px; }

  .row{ display:flex; gap:14px; flex-wrap:wrap; }
  .half{ flex:1; min-width:320px; }

  .tableWrap{ width:100%; overflow:auto; border:1px solid var(--line); border-radius:12px; }
  table{ width:100%; border-collapse: collapse; min-width: 980px; }
  th, td{ border-bottom:1px solid var(--line); padding:10px; text-align:left; vertical-align:top; }
  th{ color:var(--muted); font-size:12px; }

  /* =========================
     COMPACT CATEGORY UI
  ========================= */
  .catCompact{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .catInputWrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex:1;
    min-width: 240px;
  }
  .catInputWrap input{ flex:1; }
  .chipRow{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:10px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background: rgba(0,0,0,0.03);
    font-weight:900;
    font-size:12px;
  }
  [data-theme="dark"] .chip{ background: rgba(255,255,255,0.06); }

  .chipX{
    border:none;
    background: transparent;
    color: var(--danger);
    font-weight: 900;
    cursor:pointer;
    padding:0;
    line-height:1;
    font-size:16px;
  }

  /* =========================
     PHONE: add-entry becomes 2 rows
  ========================= */
  @media (max-width: 700px){
    .grid4{ grid-template-columns: 1fr 1fr; }
    table{ min-width: 860px; }
  }
</style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="title">Finances</div>
      <div class="hud">
        <div class="menuWrap">
          <button class="menuBtn" id="menuBtn" aria-haspopup="true" aria-expanded="false">☰</button>
          <div class="menu" id="menu">
            <div class="menuItem">
              <span style="font-weight:900;">Darkmode</span>
              <input class="switch" type="checkbox" id="darkToggle">
            </div>
            <a class="menuLink" href="./index.html">Tasks</a>
            <a class="menuLink" href="./finances.html">Finances</a>
            <a class="menuLink" href="./jobs.html">Jobs</a>
            <a class="menuLink" href="./statistics.html">Statistics</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- EXPENSE CATEGORIES (COMPACT) -->
    <div class="card">
      <h3 style="margin:0 0 10px 0;">Expense categories</h3>

      <div class="catCompact">
        <div class="catInputWrap">
          <input id="newCat" placeholder="Add category (e.g. Food)" />
          <button onclick="FinanceCats.add()">Add</button>
        </div>
        <div class="muted">Used only for outgoing entries.</div>
      </div>

      <div class="chipRow" id="catList"></div>
    </div>

    <!-- ADD ENTRY -->
    <div class="card">
      <h3 style="margin:0 0 10px 0;">Add entry</h3>

      <div class="grid4">
        <input id="desc" placeholder="Description (rent, wage, food...)" />
        <input id="amount" type="number" placeholder="Amount" />
        <select id="type" onchange="Finance.onTypeChange()">
          <option value="income">Income</option>
          <option value="outgoing">Outgoing</option>
        </select>
        <input id="date" type="date" />
      </div>

      <div style="margin-top:10px;">
        <select id="expenseCat" style="display:none;"></select>
      </div>

      <div style="margin-top:10px;">
        <button onclick="Finance.add()">Add</button>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row">
      <div class="card half">
        <h3 style="margin:0 0 10px 0;">This week: income vs outgoing</h3>
        <canvas id="weekBar" height="140"></canvas>
      </div>
      <div class="card half">
        <h3 style="margin:0 0 10px 0;">Balance trend (last 30 days)</h3>
        <canvas id="balanceLine" height="140"></canvas>
      </div>
    </div>

    <!-- ENTRIES TABLE -->
    <div class="card">
      <h3 style="margin:0 0 10px 0;">Entries</h3>
      <div class="tableWrap">
        <table id="finTable"></table>
      </div>
    </div>

    <!-- STARTING CASH MOVED TO BOTTOM -->
    <div class="card">
      <h3 style="margin:0 0 10px 0;">Money you have (starting cash)</h3>
      <div class="grid2">
        <input id="startingCash" type="number" placeholder="e.g. 1200" />
        <button onclick="Finance.saveStarting()">Save</button>
      </div>
      <div class="muted" style="margin-top:8px;">Balance = starting cash + income - outgoing.</div>
      <div style="margin-top:10px; font-weight:900;">Current balance: <span id="balance">$0</span></div>
    </div>

  </div>

<script>
/* =========================================================
  BLOCK 0 — THEME + MENU
========================================================= */
const LS = {
  get(key, fallback){
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  },
  set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
};

(function ThemeAndMenuInit(){
  const darkToggle = document.getElementById("darkToggle");
  const savedTheme = LS.get("theme", "light");
  document.documentElement.setAttribute("data-theme", savedTheme);
  darkToggle.checked = savedTheme === "dark";

  darkToggle.addEventListener("change", () => {
    const t = darkToggle.checked ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", t);
    LS.set("theme", t);
  });

  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");

  function setOpen(open){
    if (open){
      menu.classList.add("open");
      menuBtn.setAttribute("aria-expanded","true");
    } else {
      menu.classList.remove("open");
      menuBtn.setAttribute("aria-expanded","false");
    }
  }

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    setOpen(!menu.classList.contains("open"));
  });
  document.addEventListener("click", () => setOpen(false));
})();

/* =========================================================
  BLOCK 1 — TIME HELPERS (PHONE LOCAL DATE)
========================================================= */
function localDateKey(d=new Date()){
  const yr = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${yr}-${mo}-${da}`;
}
function startOfWeekMonday(d){
  const x = new Date(d);
  const day = x.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  x.setHours(0,0,0,0);
  return x;
}

/* =========================================================
  BLOCK 2 — CATEGORY MANAGER (OUTGOING ONLY)
========================================================= */
const FinanceCats = (() => {
  let cats = LS.get("fin_cats_v1", ["Food", "Transport", "Rent", "Bills", "Other"]);
  function persist(){ LS.set("fin_cats_v1", cats); }

  function add(){
    const name = document.getElementById("newCat").value.trim();
    if (!name) return;
    if (cats.some(c => c.toLowerCase() === name.toLowerCase())) return alert("Category exists.");
    cats.push(name);
    persist();
    document.getElementById("newCat").value = "";
    render();
    Finance.renderCatSelect();
  }

  function remove(name){
    const entries = LS.get("fin_entries_v1", []);
    const used = entries.some(e => e.type === "outgoing" && e.category === name);
    if (used) return alert("Category is used by an entry. Change/delete those entries first.");

    cats = cats.filter(c => c !== name);
    persist();
    render();
    Finance.renderCatSelect();
  }

  function list(){ return cats; }

  function render(){
    const host = document.getElementById("catList");
    host.innerHTML = "";

    if (cats.length === 0){
      host.innerHTML = `<div class="muted">No categories. Add one above.</div>`;
      return;
    }

    cats.forEach(c => {
      const chip = document.createElement("div");
      chip.className = "chip";

      const label = document.createElement("span");
      label.textContent = c;

      const x = document.createElement("button");
      x.className = "chipX";
      x.textContent = "×";
      x.title = "Delete category";
      x.addEventListener("click", () => remove(c));

      chip.appendChild(label);
      chip.appendChild(x);
      host.appendChild(chip);
    });
  }

  return { add, remove, list, render };
})();

/* =========================================================
  BLOCK 3 — FINANCE APP
========================================================= */
function uuid(){
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2);
}

const Finance = (() => {
  let starting = LS.get("fin_startingCash_v1", 0);
  let entries = LS.get("fin_entries_v1", []); // {id,date,type,amount,desc,ts,category?}

  let weekBarChart = null;
  let balanceLineChart = null;

  function persist(){
    LS.set("fin_startingCash_v1", starting);
    LS.set("fin_entries_v1", entries);
  }

  function renderCatSelect(){
    const sel = document.getElementById("expenseCat");
    sel.innerHTML = "";
    FinanceCats.list().forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }

  function onTypeChange(){
    const type = document.getElementById("type").value;
    const sel = document.getElementById("expenseCat");
    sel.style.display = (type === "outgoing") ? "" : "none";
  }

  function saveStarting(){
    const v = Number(document.getElementById("startingCash").value);
    if (Number.isNaN(v)) return alert("Enter a number.");
    starting = v;
    persist();
    renderAll();
  }

  function add(){
    const desc = document.getElementById("desc").value.trim();
    const amount = Number(document.getElementById("amount").value);
    const type = document.getElementById("type").value;
    const date = document.getElementById("date").value || localDateKey(new Date());

    if (!desc) return alert("Add a description.");
    if (Number.isNaN(amount) || amount <= 0) return alert("Amount must be > 0.");

    const ts = new Date(date + "T12:00:00").getTime();
    const entry = { id: uuid(), date, type, amount, desc, ts };

    if (type === "outgoing"){
      entry.category = document.getElementById("expenseCat").value || "Other";
    }

    entries.push(entry);
    entries.sort((a,b)=> a.ts - b.ts);
    persist();

    document.getElementById("desc").value = "";
    document.getElementById("amount").value = "";
    renderAll();
  }

  function remove(id){
    entries = entries.filter(e => e.id !== id);
    persist();
    renderAll();
  }

  function computeBalance(){
    let bal = Number(starting) || 0;
    for (const e of entries){
      if (e.type === "income") bal += e.amount;
      if (e.type === "outgoing") bal -= e.amount;
    }
    return bal;
  }

  function renderTable(){
    const t = document.getElementById("finTable");
    const rows = [...entries].sort((a,b)=> b.ts - a.ts);

    t.innerHTML = `
      <thead>
        <tr>
          <th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Description</th><th></th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(e => `
          <tr>
            <td>${e.date}</td>
            <td>${e.type}</td>
            <td>${e.type === "outgoing" ? (e.category || "Other") : "-"}</td>
            <td>${e.type==="outgoing" ? "-" : "+"}$${Number(e.amount).toFixed(2)}</td>
            <td>${escapeHtml(e.desc)}</td>
            <td style="text-align:right;">
              <button class="xBtn" title="Delete" onclick="Finance.remove('${e.id}')">×</button>
            </td>
          </tr>
        `).join("")}
        ${rows.length===0 ? `<tr><td colspan="6" class="muted">No entries yet.</td></tr>` : ""}
      </tbody>
    `;
  }

  function renderCharts(){
    const now = new Date();
    const ws = startOfWeekMonday(now);
    const we = new Date(ws); we.setDate(we.getDate()+7);

    let incomeWeek = 0, outgoingWeek = 0;
    for (const e of entries){
      if (e.ts >= ws.getTime() && e.ts < we.getTime()){
        if (e.type === "income") incomeWeek += e.amount;
        if (e.type === "outgoing") outgoingWeek += e.amount;
      }
    }

    const weekCtx = document.getElementById("weekBar");
    if (weekBarChart) weekBarChart.destroy();
    weekBarChart = new Chart(weekCtx, {
      type:"bar",
      data:{
        labels:["This week"],
        datasets:[
          { label:"Income", data:[incomeWeek] },
          { label:"Outgoing", data:[outgoingWeek] }
        ]
      },
      options:{ responsive:true }
    });

    const days = [];
    const balances = [];
    const start = new Date(); start.setDate(start.getDate()-29);
    start.setHours(0,0,0,0);

    const netByDay = {};
    for (const e of entries){
      const k = e.date;
      netByDay[k] = netByDay[k] || 0;
      netByDay[k] += (e.type === "income") ? e.amount : -e.amount;
    }

    let base = Number(starting) || 0;
    for (const e of entries){
      const d = new Date(e.date + "T12:00:00");
      if (d < start){
        base += (e.type === "income") ? e.amount : -e.amount;
      }
    }

    let running = base;
    for (let i=0;i<30;i++){
      const d = new Date(start); d.setDate(d.getDate()+i);
      const k = localDateKey(d);
      days.push(k.slice(5));
      running += (netByDay[k] || 0);
      balances.push(running);
    }

    const balCtx = document.getElementById("balanceLine");
    if (balanceLineChart) balanceLineChart.destroy();
    balanceLineChart = new Chart(balCtx, {
      type:"line",
      data:{ labels:days, datasets:[{ label:"Balance", data:balances, tension:0.25 }] },
      options:{ responsive:true }
    });
  }

  function renderAll(){
    document.getElementById("startingCash").value = starting;
    document.getElementById("balance").textContent = "$" + computeBalance().toFixed(2);
    renderTable();
    renderCharts();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  return { saveStarting, add, remove, renderAll, onTypeChange, renderCatSelect };
})();

/* =========================================================
  INIT
========================================================= */
FinanceCats.render();
Finance.renderCatSelect();
Finance.onTypeChange();
Finance.renderAll();
</script>
</body>
</html>
