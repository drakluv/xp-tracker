<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Statistics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:rgba(0,0,0,0.10);

    --primary:#7c3aed;
    --primary2:#2563eb;

    --accent:#22c55e;
    --danger:#ef4444;

    --shadow:0 10px 30px rgba(0,0,0,0.12);
    --radius:14px;

    --hudBg: rgba(255,255,255,0.14);
    --hudBorder: rgba(255,255,255,0.22);
  }

  [data-theme="dark"]{
    --bg:#0b1220;
    --card:#111a2e;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:rgba(255,255,255,0.12);
    --shadow:0 10px 30px rgba(0,0,0,0.45);

    --hudBg: rgba(255,255,255,0.10);
    --hudBorder: rgba(255,255,255,0.18);
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* =========================
     TOP BAR + MENU (like main)
  ========================= */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 999;
    padding: 14px 14px;
    background: linear-gradient(90deg, var(--primary), var(--primary2));
    color:#fff;
    box-shadow: var(--shadow);
  }

  .topbarInner{
    max-width: 1100px;
    margin: 0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .title{
    font-weight: 900;
    font-size: 18px;
    letter-spacing: 0.2px;
  }

  .hud{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:10px;
  }

  .menuWrap{ position:relative; }
  .menuBtn{
    border:1px solid var(--hudBorder);
    background: linear-gradient(90deg, rgba(14,165,233,0.28), rgba(34,197,94,0.22));
    color:#fff;
    padding:10px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 900;
    min-width: 44px;
    text-align:center;
  }

  .menu{
    position:absolute;
    right:0;
    top:48px;
    width: 240px;
    background: var(--card);
    color: var(--text);
    border:1px solid var(--line);
    border-radius: 14px;
    box-shadow: var(--shadow);
    padding: 10px;
    display:none;
    z-index: 1000;
  }
  .menu.open{ display:block; }

  .menuItem{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border-radius: 12px;
  }
  .menuItem:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuItem:hover{ background: rgba(255,255,255,0.06); }

  .menuLink{
    display:block;
    padding:10px;
    border-radius: 12px;
    color: var(--text);
    text-decoration:none;
    font-weight: 900;
  }
  .menuLink:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuLink:hover{ background: rgba(255,255,255,0.06); }

  .switch{
    width: 22px;
    height: 22px;
    accent-color: var(--accent);
  }

  /* =========================
     PAGE LAYOUT
  ========================= */
  .page{
    max-width:1100px;
    margin:0 auto;
    padding:16px;
  }

  .card{
    background: var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 14px;
    margin-bottom: 14px;
  }

  h2{
    margin:0 0 10px 0;
    font-size:16px;
    letter-spacing:0.2px;
  }

  .muted{ color:var(--muted); font-size:12px; }

  .row{
    display:flex;
    gap:14px;
    flex-wrap:wrap;
  }
  .half{
    flex:1;
    min-width:320px;
  }

  /* =========================
     CALENDAR
  ========================= */
  .calHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .calTitle{
    font-weight:900;
    letter-spacing:0.2px;
  }
  .calBtns{
    display:flex;
    gap:8px;
  }
  .btn{
    padding:10px 12px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    color:#fff;
    background: linear-gradient(90deg,var(--accent),#16a34a);
  }

  .calGrid{
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:8px;
  }
  .dow{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    letter-spacing:0.2px;
    text-align:center;
    padding:6px 0;
  }
  .day{
    border:1px solid var(--line);
    border-radius: 12px;
    padding:10px;
    min-height: 64px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .dayNum{
    font-weight:900;
    font-size:12px;
    opacity:0.9;
  }
  .badge{
    font-size:11px;
    font-weight:900;
    padding:4px 8px;
    border-radius:999px;
    width: fit-content;
  }
  .ok{ background: rgba(34,197,94,0.18); border:1px solid rgba(34,197,94,0.30); }
  .miss{ background: rgba(239,68,68,0.16); border:1px solid rgba(239,68,68,0.30); }
  .future{ background: rgba(107,114,128,0.14); border:1px solid rgba(107,114,128,0.22); }
  .empty{ background: transparent; border:1px dashed var(--line); opacity:0.6; }
</style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="title">Statistics</div>

      <div class="hud">
        <div class="menuWrap">
          <button class="menuBtn" id="menuBtn" aria-haspopup="true" aria-expanded="false">☰</button>
          <div class="menu" id="menu">
            <div class="menuItem">
              <span style="font-weight:900;">Darkmode</span>
              <input class="switch" type="checkbox" id="darkToggle">
            </div>
            <a class="menuLink" href="./index.html">Tasks</a>
            <a class="menuLink" href="./finances.html">Finances</a>
            <a class="menuLink" href="./jobs.html">Jobs</a>
            <a class="menuLink" href="./statistics.html">Statistics</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="page">

    <div class="card">
      <div class="muted">Uses your phone’s local time. Week = Monday → Sunday.</div>
    </div>

    <div class="row">
      <div class="card half">
        <h2>Tasks completed by category (this week)</h2>
        <canvas id="catChart" height="140"></canvas>
      </div>

      <div class="card half">
        <h2>Gym frequency (this week)</h2>
        <canvas id="gymChart" height="140"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>GP earned per day (this week)</h2>
      <canvas id="gpChart" height="110"></canvas>
    </div>

    <div class="row">
      <div class="card half">
        <h2>Streak history (last 30 days)</h2>
        <canvas id="streakChart" height="140"></canvas>
      </div>

      <div class="card half">
        <h2>Money: income vs outgoing (last 8 weeks)</h2>
        <canvas id="moneyChart" height="140"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="calHeader">
        <div class="calTitle" id="calTitle">Daily Completion Calendar</div>
        <div class="calBtns">
          <button class="btn" onclick="Calendar.prev()">‹</button>
          <button class="btn" onclick="Calendar.today()">Today</button>
          <button class="btn" onclick="Calendar.next()">›</button>
        </div>
      </div>

      <div class="calGrid" id="calGrid">
        <!-- Rendered by JS -->
      </div>

      <div class="muted" style="margin-top:10px;">
        Calendar is based on “ALL daily tasks completed on that day”.
      </div>
    </div>

  </div>

<script>
/* =========================================================
  BLOCK 0 — THEME + MENU
========================================================= */
const LS = {
  get(key, fallback){
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  },
  set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
};

(function ThemeAndMenuInit(){
  const darkToggle = document.getElementById("darkToggle");
  const savedTheme = LS.get("theme", "light");
  document.documentElement.setAttribute("data-theme", savedTheme);
  darkToggle.checked = savedTheme === "dark";

  darkToggle.addEventListener("change", () => {
    const t = darkToggle.checked ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", t);
    LS.set("theme", t);
  });

  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");

  function setOpen(open){
    if (open){
      menu.classList.add("open");
      menuBtn.setAttribute("aria-expanded","true");
    } else {
      menu.classList.remove("open");
      menuBtn.setAttribute("aria-expanded","false");
    }
  }

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    setOpen(!menu.classList.contains("open"));
  });
  document.addEventListener("click", () => setOpen(false));
})();

/* =========================================================
  BLOCK 1 — TIME HELPERS (PHONE LOCAL TIME)
========================================================= */
function localDateKey(d=new Date()){
  const yr = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${yr}-${mo}-${da}`;
}
function startOfWeekMonday(d){
  const x = new Date(d);
  const day = x.getDay(); // 0 Sun..6 Sat
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  x.setHours(0,0,0,0);
  return x;
}
function dayIndexMon0(d){
  const day = d.getDay();
  return (day === 0) ? 6 : (day - 1);
}
function weekKeyFor(d){
  return localDateKey(startOfWeekMonday(d));
}

/* =========================================================
  BLOCK 2 — LOAD DATA (from other pages)
========================================================= */
const events = LS.get("eventLog_v1", []);
const categories = LS.get("categories_v0", [{id:"cat_general", name:"General"}]);
const dailyRows = LS.get("dailyRows_v0", []);
const dailyChecks = LS.get("dailyChecks_v0", {});
const finEntries = LS.get("fin_entries_v1", []);

/* =========================================================
  BLOCK 3 — DAILY COMPLETION CHECK (ALL daily rows done)
========================================================= */
function isDailyCompleteOnDate(dateObj){
  if (!dailyRows || dailyRows.length === 0) return false;

  const wk = weekKeyFor(dateObj);
  const idx = dayIndexMon0(dateObj);
  const grid = dailyChecks[wk] || {};

  for (const row of dailyRows){
    const cell = grid?.[row.id]?.[idx];
    if (!cell) return false;
  }
  return true;
}

/* =========================================================
  BLOCK 4 — WEEKLY CHARTS (tasks by category, gym, gp)
========================================================= */
(function WeeklyCharts(){
  const now = new Date();
  const ws = startOfWeekMonday(now);
  const we = new Date(ws); we.setDate(we.getDate()+7);

  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  const catName = (id) => (categories.find(c=>c.id===id)?.name || "Unknown");

  // Tasks completed by category (net complete - undo)
  const catCounts = {};
  events.forEach(e => {
    if (e.ts < ws.getTime() || e.ts >= we.getTime()) return;
    if (e.kind !== "task") return;
    const catId = e.meta?.catId || "cat_general";
    const k = catName(catId);
    catCounts[k] = catCounts[k] || 0;
    if (e.action === "complete") catCounts[k] += 1;
    if (e.action === "undo") catCounts[k] -= 1;
  });
  Object.keys(catCounts).forEach(k => { if (catCounts[k] < 0) catCounts[k] = 0; });

  const catLabels = Object.keys(catCounts);
  const catData = catLabels.map(k => catCounts[k]);

  new Chart(document.getElementById("catChart"), {
    type: "bar",
    data: {
      labels: catLabels.length ? catLabels : ["(none)"],
      datasets: [{ label:"Completed", data: catLabels.length ? catData : [0] }]
    },
    options: { responsive:true, plugins:{ legend:{ display:false } } }
  });

  // Gym frequency (from dailyChecks, rows with isGym)
  const wkKey = weekKeyFor(now);
  const weekGrid = dailyChecks[wkKey] || {};
  const gymRows = (dailyRows || []).filter(r => r.isGym);
  const gymPerDay = [0,0,0,0,0,0,0];
  gymRows.forEach(r => {
    const g = weekGrid[r.id] || {};
    for (let i=0;i<7;i++) if (g[i]) gymPerDay[i] += 1;
  });

  new Chart(document.getElementById("gymChart"), {
    type: "bar",
    data: { labels: days, datasets: [{ label:"Gym", data: gymPerDay }] },
    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });

  // GP earned per day (earned, not net)
  const gpEarned = [0,0,0,0,0,0,0];
  events.forEach(e => {
    if (e.ts < ws.getTime() || e.ts >= we.getTime()) return;
    const i = dayIndexMon0(new Date(e.ts));

    if (e.kind === "daily" && e.action === "check") gpEarned[i] += (e.gp || 0);
    if (e.kind === "task" && e.action === "complete") gpEarned[i] += (e.gp || 0);
    if (e.kind === "gp" && e.action === "add") gpEarned[i] += (e.gp || 0);
  });

  new Chart(document.getElementById("gpChart"), {
    type: "line",
    data: { labels: days, datasets: [{ label:"GP earned", data: gpEarned, tension:0.25 }] },
    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  });
})();

/* =========================================================
  BLOCK 5 — STREAK HISTORY (reconstructed from daily completion)
========================================================= */
(function StreakHistory(){
  const labels = [];
  const streakVals = [];

  let streak = 0;
  const today = new Date();
  // last 30 days including today
  for (let back=29; back>=0; back--){
    const d = new Date(today);
    d.setDate(d.getDate() - back);

    const ok = isDailyCompleteOnDate(d);
    if (ok) streak += 1;
    else streak = 0;

    labels.push(localDateKey(d).slice(5)); // MM-DD
    streakVals.push(streak);
  }

  new Chart(document.getElementById("streakChart"), {
    type: "line",
    data: { labels, datasets: [{ label:"Streak", data: streakVals, tension:0.25 }] },
    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });
})();

/* =========================================================
  BLOCK 6 — MONEY CHART (income vs outgoing, last 8 weeks)
========================================================= */
(function MoneyChart(){
  function weekStartKey(d){
    const ws = startOfWeekMonday(d);
    return localDateKey(ws);
  }

  // build buckets for last 8 weeks (including this week)
  const buckets = [];
  const labels = [];
  const now = new Date();
  const thisWs = startOfWeekMonday(now);

  for (let i=7; i>=0; i--){
    const ws = new Date(thisWs);
    ws.setDate(ws.getDate() - i*7);
    const key = localDateKey(ws);
    buckets.push({ key, income:0, outgoing:0 });
    labels.push(key.slice(5)); // MM-DD
  }

  const bucketMap = new Map(buckets.map(b => [b.key, b]));

  finEntries.forEach(e => {
    const d = new Date((e.date || "") + "T12:00:00");
    if (Number.isNaN(d.getTime())) return;

    const wsKey = weekStartKey(d);
    const b = bucketMap.get(wsKey);
    if (!b) return;

    if (e.type === "income") b.income += Number(e.amount) || 0;
    if (e.type === "outgoing") b.outgoing += Number(e.amount) || 0;
  });

  const incomeData = buckets.map(b => b.income);
  const outgoingData = buckets.map(b => b.outgoing);

  new Chart(document.getElementById("moneyChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label:"Income", data: incomeData },
        { label:"Outgoing", data: outgoingData }
      ]
    },
    options: { responsive:true }
  });
})();

/* =========================================================
  BLOCK 7 — CALENDAR (month view with missed/completed)
========================================================= */
const Calendar = (() => {
  const grid = document.getElementById("calGrid");
  const title = document.getElementById("calTitle");

  let view = new Date(); // current month

  const dows = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  function render(){
    grid.innerHTML = "";

    // DOW header
    dows.forEach(d => {
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = d;
      grid.appendChild(el);
    });

    const year = view.getFullYear();
    const month = view.getMonth();

    title.textContent = `Daily Completion Calendar — ${view.toLocaleString(undefined, { month:"long" })} ${year}`;

    // month start
    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);

    // convert to Mon=0..Sun=6
    let firstIdx = dayIndexMon0(first); // 0..6

    // leading blanks
    for (let i=0; i<firstIdx; i++){
      const el = document.createElement("div");
      el.className = "day empty";
      grid.appendChild(el);
    }

    const todayKey = localDateKey(new Date());

    for (let day=1; day<=last.getDate(); day++){
      const d = new Date(year, month, day);
      const key = localDateKey(d);

      const el = document.createElement("div");
      el.className = "day";

      const num = document.createElement("div");
      num.className = "dayNum";
      num.textContent = day;
      el.appendChild(num);

      let badge = document.createElement("div");
      badge.className = "badge";

      if (key > todayKey){
        badge.classList.add("future");
        badge.textContent = "Future";
      } else {
        const ok = isDailyCompleteOnDate(d);
        if (ok){
          badge.classList.add("ok");
          badge.textContent = "Completed";
        } else {
          badge.classList.add("miss");
          badge.textContent = "Missed";
        }
      }

      el.appendChild(badge);
      grid.appendChild(el);
    }
  }

  function prev(){
    view = new Date(view.getFullYear(), view.getMonth()-1, 1);
    render();
  }
  function next(){
    view = new Date(view.getFullYear(), view.getMonth()+1, 1);
    render();
  }
  function today(){
    view = new Date();
    view = new Date(view.getFullYear(), view.getMonth(), 1);
    render();
  }

  return { render, prev, next, today };
})();

Calendar.render();
</script>
</body>
</html>
