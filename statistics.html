<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Statistics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:rgba(0,0,0,0.10);

    --primary:#7c3aed;
    --primary2:#2563eb;

    --accent:#22c55e;
    --danger:#ef4444;

    --shadow:0 10px 30px rgba(0,0,0,0.12);
    --radius:14px;

    --hudBg: rgba(255,255,255,0.14);
    --hudBorder: rgba(255,255,255,0.22);
  }

  [data-theme="dark"]{
    --bg:#0b1220;
    --card:#111a2e;
    --text:#e5e7eb;
    --muted:#9ca3af;
    --line:rgba(255,255,255,0.12);
    --shadow:0 10px 30px rgba(0,0,0,0.45);

    --hudBg: rgba(255,255,255,0.10);
    --hudBorder: rgba(255,255,255,0.18);
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  /* TOP BAR + MENU */
  .topbar{
    position: sticky;
    top: 0;
    z-index: 999;
    padding: 14px 14px;
    background: linear-gradient(90deg, var(--primary), var(--primary2));
    color:#fff;
    box-shadow: var(--shadow);
  }

  .topbarInner{
    max-width: 1100px;
    margin: 0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .title{
    font-weight: 900;
    font-size: 18px;
    letter-spacing: 0.2px;
  }

  .hud{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:10px;
  }

  .menuWrap{ position:relative; }
  .menuBtn{
    border:1px solid var(--hudBorder);
    background: linear-gradient(90deg, rgba(14,165,233,0.28), rgba(34,197,94,0.22));
    color:#fff;
    padding:10px 12px;
    border-radius: 999px;
    cursor:pointer;
    font-weight: 900;
    min-width: 44px;
    text-align:center;
  }

  .menu{
    position:absolute;
    right:0;
    top:48px;
    width: 240px;
    background: var(--card);
    color: var(--text);
    border:1px solid var(--line);
    border-radius: 14px;
    box-shadow: var(--shadow);
    padding: 10px;
    display:none;
    z-index: 1000;
  }
  .menu.open{ display:block; }

  .menuItem{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px;
    border-radius: 12px;
  }
  .menuItem:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuItem:hover{ background: rgba(255,255,255,0.06); }

  .menuLink{
    display:block;
    padding:10px;
    border-radius: 12px;
    color: var(--text);
    text-decoration:none;
    font-weight: 900;
  }
  .menuLink:hover{ background: rgba(0,0,0,0.06); }
  [data-theme="dark"] .menuLink:hover{ background: rgba(255,255,255,0.06); }

  .switch{
    width: 22px;
    height: 22px;
    accent-color: var(--accent);
  }

  /* PAGE LAYOUT */
  .page{
    max-width:1100px;
    margin:0 auto;
    padding:16px;
  }

  .card{
    background: var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 14px;
    margin-bottom: 14px;
  }

  h2{
    margin:0 0 10px 0;
    font-size:16px;
    letter-spacing:0.2px;
  }

  .row{
    display:flex;
    gap:14px;
    flex-wrap:wrap;
  }
  .half{
    flex:1;
    min-width:320px;
  }

  /* RANGE SELECTOR */
  .rangeRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .rangeRow select{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: var(--card);
    color: var(--text);
    font-weight:900;
    outline:none;
    min-width: 180px;
  }
  .rangeRow select option{ background: var(--card); color: var(--text); }

  /* CALENDAR */
  .calHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .calTitle{
    font-weight:900;
    letter-spacing:0.2px;
  }
  .calBtns{
    display:flex;
    gap:8px;
  }
  .btn{
    padding:10px 12px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    color:#fff;
    background: linear-gradient(90deg,var(--accent),#16a34a);
  } 
  .dow{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    letter-spacing:0.2px;
    text-align:center;
    padding:6px 0;
  }
  .mark.ok{ background: rgba(34,197,94,0.18); border-color: rgba(34,197,94,0.30); }
  .mark.miss{ background: rgba(239,68,68,0.16); border-color: rgba(239,68,68,0.30); }
  .mark.future{ background: rgba(107,114,128,0.14); border-color: rgba(107,114,128,0.22); }
  .empty{ background: transparent; border:1px dashed var(--line); opacity:0.6; }

  /* PHONE: make calendar fit nicely */
    .dow{ font-size:11px; padding:4px 0; }
    .dayNum{ font-size:11px; }
    .mark{ font-size:14px; padding:5px 8px; min-width: 30px; }
  }
</style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="title">Statistics</div>

      <div class="hud">
        <div class="menuWrap">
          <button class="menuBtn" id="menuBtn" aria-haspopup="true" aria-expanded="false">☰</button>
          <div class="menu" id="menu">
            <div class="menuItem">
              <span style="font-weight:900;">Darkmode</span>
              <input class="switch" type="checkbox" id="darkToggle">
            </div>
            <a class="menuLink" href="./index.html">Tasks</a>
            <a class="menuLink" href="./finances.html">Finances</a>
            <a class="menuLink" href="./jobs.html">Jobs</a>
            <a class="menuLink" href="./statistics.html">Statistics</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="page">

    <div class="row">
      <div class="card half">
        <h2>Tasks completed by category (this week)</h2>
        <canvas id="catChart" height="140"></canvas>
      </div>

      <div class="card half">
        <h2>Gym frequency (this week)</h2>
        <canvas id="gymChart" height="140"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>GP earned per day (this week)</h2>
      <canvas id="gpChart" height="110"></canvas>
    </div>

    <div class="row">
      <div class="card half">
        <h2>Streak history (last 30 days)</h2>
        <canvas id="streakChart" height="140"></canvas>
      </div>

      <div class="card half">
        <div class="rangeRow">
          <h2 style="margin:0;">Money: income vs expenses</h2>
          <select id="moneyRange">
            <option value="weekly" selected>Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>
        <canvas id="moneyChart" height="140"></canvas>
      </div>
    </div>

    <div class="row">
      <div class="card half">
        <h2>Spending by category (this month)</h2>
        <canvas id="spendChart" height="140"></canvas>
      </div>

      <div class="card half">
        <h2>Daily Completion Calendar</h2>
        <div class="calHeader" style="margin-top:8px;">
          <div class="calTitle" id="calTitle"></div>
          <div class="calBtns">
            <button class="btn" onclick="Calendar.prev()">‹</button>
            <button class="btn" onclick="Calendar.today()">Today</button>
            <button class="btn" onclick="Calendar.next()">›</button>
          </div>
        </div>

        <div class="calGrid" id="calGrid"></div>
      </div>
    </div>

  </div>

<script>
/* =========================================================
  BLOCK 0 — THEME + MENU
========================================================= */
const LS = {
  get(key, fallback){
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
    catch { return fallback; }
  },
  set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
};

(function ThemeAndMenuInit(){
  const darkToggle = document.getElementById("darkToggle");
  const savedTheme = LS.get("theme", "light");
  document.documentElement.setAttribute("data-theme", savedTheme);
  darkToggle.checked = savedTheme === "dark";

  darkToggle.addEventListener("change", () => {
    const t = darkToggle.checked ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", t);
    LS.set("theme", t);
  });

  const menuBtn = document.getElementById("menuBtn");
  const menu = document.getElementById("menu");

  function setOpen(open){
    if (open){
      menu.classList.add("open");
      menuBtn.setAttribute("aria-expanded","true");
    } else {
      menu.classList.remove("open");
      menuBtn.setAttribute("aria-expanded","false");
    }
  }

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    setOpen(!menu.classList.contains("open"));
  });
  document.addEventListener("click", () => setOpen(false));
})();

/* =========================================================
  BLOCK 1 — TIME HELPERS
========================================================= */
function localDateKey(d=new Date()){
  const yr = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${yr}-${mo}-${da}`;
}
function startOfWeekMonday(d){
  const x = new Date(d);
  const day = x.getDay(); // 0 Sun..6 Sat
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  x.setHours(0,0,0,0);
  return x;
}
function dayIndexMon0(d){
  const day = d.getDay();
  return (day === 0) ? 6 : (day - 1);
}
function weekKeyFor(d){
  return localDateKey(startOfWeekMonday(d));
}
function monthKey(d){
  const yr = d.getFullYear();
  const mo = String(d.getMonth()+1).padStart(2,'0');
  return `${yr}-${mo}`;
}

/* =========================================================
  BLOCK 2 — LOAD DATA (from other pages)
========================================================= */
const events      = LS.get("eventLog_v1", []);
const categories  = LS.get("categories_v0", [{id:"cat_general", name:"General"}]);
const dailyRows   = LS.get("dailyRows_v0", []);
const dailyChecks = LS.get("dailyChecks_v0", {});

// Finance: prefer v2 (your current finances page), fall back to v1
const finEntries  = LS.get("fin_entries_v2", LS.get("fin_entries_v1", []));
const finCats     = LS.get("fin_cats_v2", LS.get("fin_cats_v1", []));

/* =========================================================
  BLOCK 3 — DAILY COMPLETION CHECK (ALL daily rows done)
========================================================= */
function isDailyCompleteOnDate(dateObj){
  if (!dailyRows || dailyRows.length === 0) return false;

  const wk = weekKeyFor(dateObj);
  const idx = dayIndexMon0(dateObj);
  const grid = dailyChecks[wk] || {};

  for (const row of dailyRows){
    const cell = grid?.[row.id]?.[idx];
    if (!cell) return false;
  }
  return true;
}

/* =========================================================
  BLOCK 4 — WEEKLY CHARTS (category, gym, gp)
========================================================= */
(function WeeklyCharts(){
  const now = new Date();
  const ws = startOfWeekMonday(now);
  const we = new Date(ws); we.setDate(we.getDate()+7);

  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const catName = (id) => (categories.find(c=>c.id===id)?.name || "Unknown");

  // Tasks completed by category (net complete - undo)
  const catCounts = {};
  events.forEach(e => {
    if (e.ts < ws.getTime() || e.ts >= we.getTime()) return;
    if (e.kind !== "task") return;
    const catId = e.meta?.catId || "cat_general";
    const k = catName(catId);
    catCounts[k] = catCounts[k] || 0;
    if (e.action === "complete") catCounts[k] += 1;
    if (e.action === "undo") catCounts[k] -= 1;
  });
  Object.keys(catCounts).forEach(k => { if (catCounts[k] < 0) catCounts[k] = 0; });

  const catLabels = Object.keys(catCounts);
  const catData = catLabels.map(k => catCounts[k]);

  new Chart(document.getElementById("catChart"), {
    type: "bar",
    data: {
      labels: catLabels.length ? catLabels : ["(none)"],
      datasets: [{ label:"Completed", data: catLabels.length ? catData : [0] }]
    },
    options: { responsive:true, plugins:{ legend:{ display:false } } }
  });

  // Gym frequency (from dailyChecks rows with isGym)
  const wkKey = weekKeyFor(now);
  const weekGrid = dailyChecks[wkKey] || {};
  const gymRows = (dailyRows || []).filter(r => r.isGym);
  const gymPerDay = [0,0,0,0,0,0,0];
  gymRows.forEach(r => {
    const g = weekGrid[r.id] || {};
    for (let i=0;i<7;i++) if (g[i]) gymPerDay[i] += 1;
  });

  new Chart(document.getElementById("gymChart"), {
    type: "bar",
    data: { labels: days, datasets: [{ label:"Gym", data: gymPerDay }] },
    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });

  // GP earned per day (earned, not net)
  const gpEarned = [0,0,0,0,0,0,0];
  events.forEach(e => {
    if (e.ts < ws.getTime() || e.ts >= we.getTime()) return;
    const i = dayIndexMon0(new Date(e.ts));

    if (e.kind === "daily" && e.action === "check") gpEarned[i] += (e.gp || 0);
    if (e.kind === "task" && e.action === "complete") gpEarned[i] += (e.gp || 0);
    if (e.kind === "gp" && e.action === "add") gpEarned[i] += (e.gp || 0);
  });

  new Chart(document.getElementById("gpChart"), {
    type: "line",
    data: { labels: days, datasets: [{ label:"GP earned", data: gpEarned, tension:0.25 }] },
    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  });
})();

/* =========================================================
  BLOCK 5 — STREAK HISTORY (reconstructed)
========================================================= */
(function StreakHistory(){
  const labels = [];
  const streakVals = [];

  let streak = 0;
  const today = new Date();
  for (let back=29; back>=0; back--){
    const d = new Date(today);
    d.setDate(d.getDate() - back);

    const ok = isDailyCompleteOnDate(d);
    if (ok) streak += 1;
    else streak = 0;

    labels.push(localDateKey(d).slice(5)); // MM-DD
    streakVals.push(streak);
  }

  new Chart(document.getElementById("streakChart"), {
    type: "line",
    data: { labels, datasets: [{ label:"Streak", data: streakVals, tension:0.25 }] },
    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });
})();

/* =========================================================
  BLOCK 6 — MONEY RANGE CHART (weekly/monthly/yearly)
========================================================= */
const Money = (() => {
  let moneyChart = null;

  function bucketKeyForEntry(e, mode){
    const d = new Date((e.date || "") + "T12:00:00");
    if (Number.isNaN(d.getTime())) return null;

    if (mode === "weekly") return localDateKey(startOfWeekMonday(d));
    if (mode === "monthly") return monthKey(d);
    if (mode === "yearly") return String(d.getFullYear());
    return null;
  }

  function buildBuckets(mode){
    const now = new Date();
    const buckets = [];
    const labels = [];

    if (mode === "weekly"){
      const thisWs = startOfWeekMonday(now);
      for (let i=7; i>=0; i--){
        const ws = new Date(thisWs);
        ws.setDate(ws.getDate() - i*7);
        const key = localDateKey(ws);
        buckets.push({ key, income:0, outgoing:0 });
        labels.push(key.slice(5));
      }
    }

    if (mode === "monthly"){
      const base = new Date(now.getFullYear(), now.getMonth(), 1);
      for (let i=11; i>=0; i--){
        const m = new Date(base);
        m.setMonth(m.getMonth() - i);
        const key = monthKey(m);
        buckets.push({ key, income:0, outgoing:0 });
        labels.push(key);
      }
    }

    if (mode === "yearly"){
      const year = now.getFullYear();
      for (let i=4; i>=0; i--){
        const y = String(year - i);
        buckets.push({ key:y, income:0, outgoing:0 });
        labels.push(y);
      }
    }

    return { buckets, labels };
  }

  function render(){
    const mode = document.getElementById("moneyRange").value;
    const { buckets, labels } = buildBuckets(mode);
    const map = new Map(buckets.map(b => [b.key, b]));

    finEntries.forEach(e => {
      const key = bucketKeyForEntry(e, mode);
      const b = key ? map.get(key) : null;
      if (!b) return;

      if (e.type === "income") b.income += Number(e.amount) || 0;
      if (e.type === "outgoing") b.outgoing += Number(e.amount) || 0;
    });

    const incomeData = buckets.map(b => b.income);
    const outgoingData = buckets.map(b => b.outgoing);

    const ctx = document.getElementById("moneyChart");
    if (moneyChart) moneyChart.destroy();

    moneyChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label:"Income", data: incomeData },
          { label:"Expenses", data: outgoingData }
        ]
      },
      options: { responsive:true }
    });
  }

  return { render };
})();

document.getElementById("moneyRange").addEventListener("change", Money.render);
Money.render();

/* =========================================================
  BLOCK 7 — SPENDING BY CATEGORY (THIS MONTH)
========================================================= */
(function SpendingByCategory(){
  const now = new Date();
  const keyThisMonth = monthKey(now);

  // Use finance categories list for consistent ordering, but include unknowns too.
  const sums = {};

  finEntries.forEach(e => {
    if (e.type !== "outgoing") return;
    const d = new Date((e.date || "") + "T12:00:00");
    if (Number.isNaN(d.getTime())) return;
    if (monthKey(d) !== keyThisMonth) return;

    const cat = (e.category || "Other");
    sums[cat] = (sums[cat] || 0) + (Number(e.amount) || 0);
  });

  // Build labels: known categories first, then extras
  const known = Array.isArray(finCats) ? finCats : [];
  const extras = Object.keys(sums).filter(c => !known.some(k => String(k).toLowerCase() === String(c).toLowerCase()));
  const labels = [...known.filter(c => sums[c] > 0), ...extras.filter(c => sums[c] > 0)];

  const data = labels.map(l => sums[l] || 0);

  new Chart(document.getElementById("spendChart"), {
    type: "doughnut",
    data: {
      labels: labels.length ? labels : ["(none)"],
      datasets: [{ data: labels.length ? data : [0] }]
    },
    options: { responsive:true }
  });
})();

/* =========================================================
  BLOCK 8 — CALENDAR (month view, ✔/✖/•)
========================================================= */
const Calendar = (() => {
  const grid = document.getElementById("calGrid");
  const title = document.getElementById("calTitle");
  let view = new Date(); // current month
  const dows = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  function render(){
    grid.innerHTML = "";

    // DOW header
    dows.forEach(d => {
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = d;
      grid.appendChild(el);
    });

    const year = view.getFullYear();
    const month = view.getMonth();

    title.textContent = `${view.toLocaleString(undefined, { month:"long" })} ${year}`;

    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);

    let firstIdx = dayIndexMon0(first);

    for (let i=0; i<firstIdx; i++){
      const el = document.createElement("div");
      el.className = "day empty";
      grid.appendChild(el);
    }

    const todayKey = localDateKey(new Date());

    for (let day=1; day<=last.getDate(); day++){
      const d = new Date(year, month, day);
      const key = localDateKey(d);

      const el = document.createElement("div");
      el.className = "day";

      const num = document.createElement("div");
      num.className = "dayNum";
      num.textContent = day;

      const mark = document.createElement("div");
      mark.className = "mark";

      if (key > todayKey){
        mark.classList.add("future");
        mark.textContent = "•";
      } else {
        const ok = isDailyCompleteOnDate(d);
        if (ok){
          mark.classList.add("ok");
          mark.textContent = "✔";
        } else {
          mark.classList.add("miss");
          mark.textContent = "✖";
        }
      }

      el.appendChild(num);
      el.appendChild(mark);
      grid.appendChild(el);
    }
  }

  function prev(){ view = new Date(view.getFullYear(), view.getMonth()-1, 1); render(); }
  function next(){ view = new Date(view.getFullYear(), view.getMonth()+1, 1); render(); }
  function today(){ const t = new Date(); view = new Date(t.getFullYear(), t.getMonth(), 1); render(); }

  return { render, prev, next, today };
})();

Calendar.render();
</script>
</body>
</html>
